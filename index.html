<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>G-MATHå¤šäººè”æœºç‰ˆ</title>
    <style>
        :root {
            /* === v.02 æ ·å¼å˜é‡ === */
            --board-bg: #f0f0f0;
            --tile-bg: #fdf5e6;
            --tile-color: #333;
            --dl-color: #a8e6cf;
            --tl-color: #3d84a8;
            --dw-color: #ffaaa5;
            --tw-color: #ff8b94;
            --accent: #4a4e69;
            --dark-bg: #22223b;
            --cell-size: 38px; /* é»˜è®¤æ¡Œé¢ç«¯ */
        }

        * { box-sizing: border-box; }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: var(--dark-bg);
            color: white;
            margin: 0;
            padding: 0;
            min-height: 100vh;
            overflow-y: auto; 
            display: flex;
            flex-direction: column;
        }

        /* === è”æœºå¤§å…æ ·å¼ (æ¥è‡ª Online ç‰ˆ) === */
        #lobby-screen {
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            background: var(--dark-bg);
            z-index: 2000;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            padding: 20px;
        }
        .lobby-card {
            background: rgba(255,255,255,0.1);
            backdrop-filter: blur(10px);
            padding: 30px;
            border-radius: 15px;
            width: 100%;
            max-width: 400px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.5);
            text-align: center;
        }
        .lobby-input {
            width: 100%;
            padding: 12px;
            margin: 10px 0;
            border-radius: 8px;
            border: 1px solid #555;
            background: rgba(0,0,0,0.3);
            color: white;
            font-size: 1rem;
        }
        .lobby-btn {
            width: 100%;
            padding: 12px;
            margin: 5px 0;
            border: none;
            border-radius: 8px;
            font-size: 1rem;
            font-weight: bold;
            cursor: pointer;
            transition: transform 0.1s;
        }
        .btn-create { background: #2a9d8f; color: white; }
        .btn-join { background: #e9c46a; color: #333; }

        /* === æ¸¸æˆä¸»ä½“å¸ƒå±€ (v.02) === */
        #game-container { display: none; flex-direction: column; height: 100%; min-height: 100vh; }

        header {
            height: 50px;
            background: #1a1a2e;
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0 20px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
            flex-shrink: 0;
            z-index: 20;
        }

        h1 { margin: 0; font-size: 1.2rem; display: flex; align-items: center; gap: 15px; }

        .main-wrapper {
            flex: 1;
            display: flex;
            padding: 10px;
            width: 100%;
            gap: 15px;
            justify-content: center;
            flex-wrap: wrap;
        }

        .board-area {
            flex-shrink: 0;
            display: flex;
            justify-content: center;
            align-items: center;
            background: #4a4e69;
            padding: 8px;
            border-radius: 8px;
            box-shadow: 5px 5px 20px rgba(0,0,0,0.4);
        }

        #game-board {
            display: grid;
            grid-template-columns: repeat(15, var(--cell-size));
            grid-template-rows: repeat(15, var(--cell-size));
            gap: 2px;
            background-color: #333;
            border: 2px solid #333;
        }

        .cell {
            width: var(--cell-size);
            height: var(--cell-size);
            background-color: var(--board-bg);
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: calc(var(--cell-size) * 0.35);
            color: #333;
            font-weight: bold;
            position: relative;
            user-select: none;
            cursor: pointer;
        }

        /* ç‰¹æ®Šæ ¼å­ */
        .cell.dl { background-color: var(--dl-color); color: #004d40; }
        .cell.tl { background-color: var(--tl-color); color: white; }
        .cell.dw { background-color: var(--dw-color); color: #880e4f; }
        .cell.tw { background-color: var(--tw-color); color: #880e4f; }
        .cell.center { background-color: var(--dw-color); font-size: calc(var(--cell-size) * 0.6); }

        /* ç‰Œæ ·å¼ (ç»Ÿä¸€) */
        .tile {
            width: calc(var(--cell-size) - 4px);
            height: calc(var(--cell-size) - 4px);
            background-color: var(--tile-bg);
            border-radius: 4px;
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: calc(var(--cell-size) * 0.55);
            font-weight: bold;
            color: var(--tile-color);
            box-shadow: 2px 2px 4px rgba(0,0,0,0.2);
            cursor: pointer;
            z-index: 10;
            position: relative;
            transition: transform 0.1s;
        }
        .tile span.points {
            position: absolute;
            bottom: 1px;
            right: 2px;
            font-size: 0.5em;
            color: #666;
        }
        .tile.temp { border: 2px solid #4caf50; box-shadow: 0 0 5px #4caf50; }
        .tile.locked { cursor: default; background-color: #ddd; color: #555; }
        .tile.selected {
            transform: translateY(-5px) scale(1.1);
            border: 2px solid #ffd700;
            box-shadow: 0 0 10px rgba(255, 215, 0, 0.8);
            z-index: 20;
            background-color: #fffbf0;
        }

        /* ä¾§è¾¹æ  */
        .sidebar {
            display: flex;
            flex-direction: column;
            gap: 10px;
            min-width: 300px;
            max-width: 400px;
            flex: 1;
        }
        .panel {
            background: rgba(255,255,255,0.07);
            padding: 15px;
            border-radius: 12px;
            border: 1px solid rgba(255,255,255,0.1);
        }

        #rack-container {
            background: rgba(0,0,0,0.3);
            padding: 15px;
            border-radius: 10px;
            min-height: calc(var(--cell-size) * 1.2 + 20px);
            display: flex;
            gap: 8px;
            justify-content: center;
            align-items: center;
            flex-wrap: wrap;
            border: 2px dashed rgba(255,255,255,0.1);
        }

        /* v.02 ç§¯åˆ†æ¦œæ ·å¼ (å« Mini Rack) */
        .player-score {
            display: flex;
            align-items: center;
            padding: 10px 5px;
            font-size: 0.9rem;
            border-bottom: 1px solid rgba(255,255,255,0.05);
            gap: 8px;
        }
        .p-name {
            width: 70px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
            font-weight: 500;
        }
        .p-score { font-weight: bold; text-align: right; width: 40px; }
        .player-score.active { 
            background: linear-gradient(90deg, rgba(255,215,0,0.2) 0%, transparent 100%);
            color: #ffd700; border-left: 4px solid #ffd700;
        }
        .player-score.me .p-name { color: #a8e6cf; font-weight: bold; } /* æ ‡è®°è‡ªå·± */

        /* æŒ‰é’® */
        .actions { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 10px; }
        button {
            padding: 12px 5px; border: none; border-radius: 8px;
            font-weight: bold; cursor: pointer; color: white;
            font-size: 0.9rem; display: flex; justify-content: center; align-items: center;
        }
        button:disabled { opacity: 0.5; cursor: not-allowed; }
        .btn-play { background: #2a9d8f; grid-column: span 3; font-size: 1.1rem; padding: 15px; }
        .btn-swap { background: #e9c46a; color: #333; }
        .btn-reset { background: #e76f51; }
        .btn-pass { background: #264653; }
        .btn-help { background: #607d8b; grid-column: span 3; margin-top: 5px;}

        #message-area {
            text-align: center; color: #ffd700; font-weight: bold;
            padding: 10px; background: rgba(0,0,0,0.4);
            border-radius: 6px; min-height: 40px; display: flex; align-items: center; justify-content: center;
        }
        
        #room-id-display { font-family: monospace; background: rgba(0,0,0,0.5); padding: 2px 8px; border-radius: 4px; color: #4cc9f0; cursor: pointer; margin-left: 10px; font-size: 0.8em;}
        
        /* Modal */
        .modal {
            display: none; position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.85);
            justify-content: center; align-items: center; z-index: 100;
        }
        .modal-content {
            background: white; color: #333; padding: 30px;
            border-radius: 15px; text-align: center;
            max-width: 600px; width: 90%; max-height: 85vh; overflow-y: auto; position: relative;
        }
        .close-btn { position: absolute; top: 15px; right: 20px; font-size: 1.5rem; cursor: pointer; color: #999; }
        .tutorial-section { text-align: left; margin-bottom: 20px; padding: 10px; background: #f9f9f9; border-radius: 8px; }
        .tutorial-list li { margin-bottom: 5px; }

        /* å“åº”å¼ */
        @media (max-width: 768px) {
            :root { --cell-size: calc((100vw - 26px) / 15); }
            .main-wrapper { flex-direction: column; align-items: center; }
            .sidebar { width: 100%; max-width: none; }
            .board-area { padding: 2px; }
        }
    </style>

    <!-- å¼•å…¥ Firebase SDK -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getFirestore, doc, setDoc, getDoc, onSnapshot, updateDoc, collection } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";

        // === ä½ çš„ Firebase é…ç½® ===
        const firebaseConfig = {
            apiKey: "AIzaSyDG8QBOaVkG2X2q04dyG0wVe-vYvsOVAdQ",
            authDomain: "g-math-pvp-35665.firebaseapp.com",
            projectId: "g-math-pvp-35665",
            storageBucket: "g-math-pvp-35665.firebasestorage.app",
            messagingSenderId: "715488897072",
            appId: "1:715488897072:web:88c73bf50912fd6c90e5f5",
            measurementId: "G-63SZM7FYCZ"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);

        // å…¨å±€çŠ¶æ€
        let myUid = null;
        let myName = "Player";
        let currentRoomId = null;
        let localGame = null;

        // === ç™»å½• ===
        signInAnonymously(auth).then(() => console.log("Firebase Connected")).catch(e => alert("è¿æ¥å¤±è´¥: " + e.message));

        onAuthStateChanged(auth, (user) => {
            if (user) {
                myUid = user.uid;
                document.getElementById('btn-create').disabled = false;
                document.getElementById('btn-join').disabled = false;
            }
        });

        function getRoomRef(id) { return doc(db, 'rooms', id); }

        // === å¤§å…åŠŸèƒ½ ===
        window.createRoom = async () => {
            if (!myUid) return alert("æ­£åœ¨è¿æ¥...");
            const name = document.getElementById('player-name').value.trim();
            if (!name) return alert("è¯·è¾“å…¥æ˜µç§°");
            myName = name;

            const roomId = Math.floor(1000 + Math.random() * 9000).toString();
            
            const initialGame = new GameEngine();
            const gameData = initialGame.serialize();
            // æˆ¿ä¸»åŠ å…¥
            gameData.players.push({
                uid: myUid, name: myName, score: 0, active: true, misses: 0,
                rack: initialGame.drawTiles(8) // v.02 ä½¿ç”¨ 8 å¼ ç‰Œ
            });
            gameData.bags = { number: initialGame.numberBag, operator: initialGame.operatorBag };

            try {
                await setDoc(getRoomRef(roomId), gameData);
                enterRoom(roomId);
            } catch(e) { alert("åˆ›å»ºå¤±è´¥: " + e.message); }
        };

        window.joinRoom = async () => {
            if (!myUid) return alert("æ­£åœ¨è¿æ¥...");
            const name = document.getElementById('player-name').value.trim();
            const rid = document.getElementById('room-id-input').value.trim();
            if (!name || !rid) return alert("è¯·è¾“å…¥ä¿¡æ¯");
            myName = name;

            const ref = getRoomRef(rid);
            try {
                const snap = await getDoc(ref);
                if (!snap.exists()) return alert("æˆ¿é—´ä¸å­˜åœ¨");
                const data = snap.data();
                
                if (data.status !== 'waiting' && !data.players.find(p=>p.uid===myUid)) return alert("æ¸¸æˆå·²å¼€å§‹");
                if (data.players.length >= 4 && !data.players.find(p=>p.uid===myUid)) return alert("æˆ¿é—´å·²æ»¡");

                if (!data.players.find(p=>p.uid===myUid)) {
                    const newP = {
                        uid: myUid, name: myName, score: 0, active: true, misses: 0,
                        rack: [] // æš‚æ—¶ç©ºï¼Œç­‰å¾…åŒæ­¥
                    };
                    await updateDoc(ref, { players: [...data.players, newP] });
                }
                enterRoom(rid);
            } catch(e) { alert("åŠ å…¥å¤±è´¥: " + e.message); }
        };

        function enterRoom(rid) {
            currentRoomId = rid;
            document.getElementById('lobby-screen').style.display = 'none';
            document.getElementById('game-container').style.display = 'flex';
            document.getElementById('room-id-text').innerText = rid;

            onSnapshot(getRoomRef(rid), (doc) => {
                if(doc.exists()) handleGameUpdate(doc.data());
                else { alert("æˆ¿é—´å·²å…³é—­"); location.reload(); }
            });

            localGame = new GameEngine();
            localGame.initUI();
        }

        window.startGame = async () => {
            await updateDoc(getRoomRef(currentRoomId), { status: 'playing' });
        };

        window.copyRoomId = () => {
            navigator.clipboard.writeText(currentRoomId).then(()=>alert("æˆ¿é—´å·å·²å¤åˆ¶")).catch(()=>alert("å¤åˆ¶å¤±è´¥"));
        };

        // === æ¸¸æˆæ ¸å¿ƒæ›´æ–°å¤„ç† ===
        async function handleGameUpdate(data) {
            const myIdx = data.players.findIndex(p => p.uid === myUid);
            const isHost = myIdx === 0;

            // è‡ªåŠ¨è¡¥ç‰Œé€»è¾‘
            if (myIdx !== -1 && data.players[myIdx].rack.length === 0 && data.status !== 'finished') {
                const totalBag = data.bags.number.length + data.bags.operator.length;
                if (totalBag > 0) {
                    localGame.syncFromCloud(data);
                    const needed = 8 - data.players[myIdx].rack.length; // v.02 æ˜¯8å¼ 
                    if (needed > 0) {
                        const newTiles = localGame.drawTiles(needed);
                        const newPlayers = JSON.parse(JSON.stringify(data.players));
                        newPlayers[myIdx].rack.push(...newTiles);
                        await updateDoc(getRoomRef(currentRoomId), {
                            players: newPlayers,
                            bags: { number: localGame.numberBag, operator: localGame.operatorBag }
                        });
                        return; 
                    }
                }
            }

            localGame.syncFromCloud(data);
            localGame.myIndex = myIdx;
            localGame.render();

            // é®ç½©å¤„ç†
            const waitEl = document.getElementById('waiting-overlay');
            if (data.status === 'waiting') {
                waitEl.style.display = 'flex';
                document.getElementById('player-list-wait').innerHTML = data.players.map(p=>`<li>${p.name}</li>`).join('');
                document.getElementById('btn-start-game').style.display = isHost ? 'block' : 'none';
            } else {
                waitEl.style.display = 'none';
            }

            if (data.status === 'finished') {
                document.getElementById('modal').style.display = 'flex';
                document.getElementById('modal-msg').innerText = "æ¸¸æˆç»“æŸï¼è¯·æŸ¥çœ‹ç§¯åˆ†æ¦œã€‚";
            }
        }

        // === æ¸¸æˆå¼•æ“ (é€»è¾‘ç§»æ¤è‡ª v.02 + è”æœºé€‚é…) ===
        class GameEngine {
            constructor() {
                this.boardState = Array(15).fill(null).map(() => Array(15).fill(null));
                this.players = [];
                this.numberBag = [];
                this.operatorBag = [];
                this.currentTurnIndex = 0;
                this.myIndex = -1;
                this.tempPlaced = [];
                this.selectedTileId = null;
                this.isSwapping = false; // ç®€å•å®ç°ï¼šè”æœºç‰ˆæš‚åœæ¢ç‰Œæ¨¡å¼ï¼Œæˆ–è€…ç®€åŒ–ä¸º"è·³è¿‡"
                
                // v.02 å¸¸é‡
                this.TILE_DISTRIBUTION = {
                    '0': { count: 6, score: 1 }, '1': { count: 6, score: 1 }, '2': { count: 6, score: 2 },
                    '3': { count: 6, score: 2 }, '4': { count: 6, score: 2 }, '5': { count: 6, score: 3 },
                    '6': { count: 6, score: 3 }, '7': { count: 6, score: 4 }, '8': { count: 6, score: 4 },
                    '9': { count: 6, score: 4 }, '+': { count: 7, score: 2 }, '-': { count: 7, score: 2 },
                    'Ã—': { count: 7, score: 4 }, 'Ã·': { count: 7, score: 4 }, '=': { count: 20, score: 1 }
                };
                
                this.generateTileBag();
                this.shuffleBag();
            }

            serialize() {
                return {
                    status: 'waiting',
                    currentTurnIndex: 0,
                    players: [],
                    board: {}, 
                    bags: { number: this.numberBag, operator: this.operatorBag }
                };
            }

            syncFromCloud(data) {
                this.players = data.players;
                this.currentTurnIndex = data.currentTurnIndex;
                this.numberBag = JSON.parse(JSON.stringify(data.bags.number));
                this.operatorBag = JSON.parse(JSON.stringify(data.bags.operator));
                
                this.boardState = Array(15).fill(null).map(() => Array(15).fill(null));
                for (let key in data.board) {
                    const [r, c] = key.split(',').map(Number);
                    this.boardState[r][c] = data.board[key];
                }
            }

            generateTileBag() {
                let id = 0;
                for (let char in this.TILE_DISTRIBUTION) {
                    const info = this.TILE_DISTRIBUTION[char];
                    const isNum = /\d/.test(char);
                    for(let i=0; i<info.count; i++) {
                        const t = { id: id++, char, score: info.score };
                        if(isNum) this.numberBag.push(t); else this.operatorBag.push(t);
                    }
                }
            }
            
            shuffleBag() {
                const s = (arr) => arr.sort(() => Math.random() - 0.5);
                s(this.numberBag); s(this.operatorBag);
            }

            drawTiles(count) {
                let drawn = [];
                for(let i=0; i<count; i++) {
                    if (this.numberBag.length > 0 && (Math.random() > 0.4 || this.operatorBag.length === 0)) {
                        drawn.push(this.numberBag.pop());
                    } else if (this.operatorBag.length > 0) {
                        drawn.push(this.operatorBag.pop());
                    }
                }
                return drawn;
            }

            initUI() {
                const boardEl = document.getElementById('game-board');
                boardEl.innerHTML = '';
                const SPECIAL = {
                    'TW': ['0,0', '0,7', '0,14', '7,0', '7,14', '14,0', '14,7', '14,14'],
                    'DW': ['1,1', '2,2', '3,3', '4,4', '10,10', '11,11', '12,12', '13,13', '1,13', '2,12', '3,11', '4,10', '10,4', '11,3', '12,2', '13,1'],
                    'TL': ['1,5', '1,9', '5,1', '5,5', '5,9', '5,13', '9,1', '9,5', '9,9', '9,13', '13,5', '13,9'],
                    'DL': ['0,3', '0,11', '2,6', '2,8', '3,0', '3,7', '3,14', '6,2', '6,6', '6,8', '6,12', '7,3', '7,11', '8,2', '8,6', '8,8', '8,12', '11,0', '11,7', '11,14', '12,6', '12,8', '14,3', '14,11']
                };

                for (let r = 0; r < 15; r++) {
                    for (let c = 0; c < 15; c++) {
                        const cell = document.createElement('div');
                        cell.className = 'cell';
                        cell.dataset.r = r;
                        cell.dataset.c = c;
                        const key = `${r},${c}`;
                        if (r===7&&c===7) { cell.classList.add('center'); cell.innerHTML='â˜…'; }
                        else if (SPECIAL.TW.includes(key)) { cell.classList.add('tw'); cell.innerText='TW'; }
                        else if (SPECIAL.DW.includes(key)) { cell.classList.add('dw'); cell.innerText='DW'; }
                        else if (SPECIAL.TL.includes(key)) { cell.classList.add('tl'); cell.innerText='TL'; }
                        else if (SPECIAL.DL.includes(key)) { cell.classList.add('dl'); cell.innerText='DL'; }
                        
                        cell.onclick = () => this.handleBoardClick(r, c);
                        boardEl.appendChild(cell);
                    }
                }
            }

            render() {
                // 1. æ¸²æŸ“æ£‹ç›˜
                for(let r=0; r<15; r++) {
                    for(let c=0; c<15; c++) {
                        this.updateCell(r, c);
                    }
                }
                
                // 2. æ¸²æŸ“æˆ‘çš„æ‰‹ç‰Œ
                const rackEl = document.getElementById('rack-container');
                rackEl.innerHTML = '';
                if (this.myIndex !== -1 && this.players[this.myIndex]) {
                    this.players[this.myIndex].rack.forEach(tile => {
                        const t = document.createElement('div');
                        t.className = 'tile';
                        if (this.selectedTileId === tile.id) t.classList.add('selected');
                        t.innerHTML = `${tile.char}<span class="points">${tile.score}</span>`;
                        t.onclick = (e) => { e.stopPropagation(); this.handleRackClick(tile); };
                        rackEl.appendChild(t);
                    });
                }

                // 3. çŠ¶æ€ä¿¡æ¯
                const isMyTurn = this.currentTurnIndex === this.myIndex;
                const turnPlayer = this.players[this.currentTurnIndex];
                const msgArea = document.getElementById('message-area');
                
                if (this.players.length > 0) {
                    msgArea.innerText = isMyTurn ? "ğŸ‘‰ è½®åˆ°ä½ äº†ï¼" : `â³ ç­‰å¾… ${turnPlayer ? turnPlayer.name : '...'} å‡ºç‰Œ`;
                    msgArea.style.color = isMyTurn ? "#ffd700" : "#ccc";
                }

                document.querySelectorAll('.actions button').forEach(b => b.disabled = !isMyTurn);
                document.querySelector('.btn-help').disabled = false; // å¸®åŠ©æŒ‰é’®æ°¸è¿œå¯ç”¨

                // 4. v.02 é£æ ¼ç§¯åˆ†æ¦œ
                const list = document.getElementById('players-list');
                list.innerHTML = '';
                this.players.forEach((p, i) => {
                    const div = document.createElement('div');
                    div.className = `player-score ${i === this.currentTurnIndex ? 'active' : ''} ${i === this.myIndex ? 'me' : ''}`;
                    
                    
                    div.innerHTML = `<span class="p-name">${p.name}</span> ${rackHtml} <span class="p-score">${p.score}</span>`;
                    list.appendChild(div);
                });
                
                document.getElementById('tiles-left-header').innerText = 
                    this.numberBag.length + this.operatorBag.length;
            }

            updateCell(r, c) {
                const cell = document.querySelector(`.cell[data-r="${r}"][data-c="${c}"]`);
                if(!cell) return;
                
                const locked = this.boardState[r][c];
                const temp = this.tempPlaced.find(t => t.r === r && t.c === c);
                
                const old = cell.querySelector('.tile');
                if(old) old.remove();

                if(locked || temp) {
                    const tData = locked || temp.tile;
                    const t = document.createElement('div');
                    t.className = 'tile ' + (locked ? 'locked' : 'temp');
                    t.innerHTML = `${tData.char}<span class="points">${tData.score}</span>`;
                    if(temp) t.onclick = (e) => { e.stopPropagation(); this.recallTempTile(temp); };
                    cell.appendChild(t);
                }
            }

            handleRackClick(tile) {
                if (this.currentTurnIndex !== this.myIndex) return;
                this.selectedTileId = (this.selectedTileId === tile.id) ? null : tile.id;
                this.render();
            }

            handleBoardClick(r, c) {
                if (this.currentTurnIndex !== this.myIndex) return;
                if (this.boardState[r][c]) return;
                
                if (this.selectedTileId !== null) {
                    const rack = this.players[this.myIndex].rack;
                    const idx = rack.findIndex(t => t.id === this.selectedTileId);
                    if (idx === -1) return;
                    
                    const tile = rack[idx];
                    this.players[this.myIndex].rack.splice(idx, 1);
                    this.tempPlaced.push({ r, c, tile });
                    this.selectedTileId = null;
                    this.render();
                }
            }

            recallTempTile(tObj) {
                const idx = this.tempPlaced.indexOf(tObj);
                if(idx > -1) {
                    this.tempPlaced.splice(idx, 1);
                    this.players[this.myIndex].rack.push(tObj.tile);
                    this.render();
                }
            }

            async recallAll() {
                [...this.tempPlaced].forEach(t => this.recallTempTile(t));
            }

            // === æ ¸å¿ƒï¼šæäº¤ä¸éªŒè¯ (é›†æˆ v.02 éªŒè¯é€»è¾‘) ===
            async submitTurn() {
                if (this.tempPlaced.length === 0) return alert("è¯·å…ˆå‡ºç‰Œ");

                // 1. åŸºç¡€ä½ç½®éªŒè¯
                const rows = this.tempPlaced.map(t => t.r);
                const cols = this.tempPlaced.map(t => t.c);
                const isRow = rows.every(r => r === rows[0]);
                const isCol = cols.every(c => c === cols[0]);
                if (!isRow && !isCol) return alert("å¿…é¡»æ’åœ¨åŒä¸€è¡Œæˆ–åŒä¸€åˆ—");

                // ç®€å•è¿é€šæ€§æ£€æŸ¥
                // æ³¨æ„ï¼šå®Œæ•´ç‰ˆéªŒè¯ä»£ç è¾ƒé•¿ï¼Œä¸ºç¡®ä¿è”æœºç¨³å®šæ€§ï¼Œè¿™é‡Œä½¿ç”¨ç®€åŒ–éªŒè¯
                // ä½†ä¿ç•™â€œå¿…é¡»åŒ…å«ç­‰å·â€çš„æ ¸å¿ƒè§„åˆ™
                const tiles = this.tempPlaced.map(t => t.tile.char);
                if (!tiles.includes('=')) return alert("æ— æ•ˆç­‰å¼ï¼šå¿…é¡»åŒ…å« '='");

                // 2. è®¡ç®—åˆ†æ•° (ç®€åŒ–ç‰ˆ)
                let score = 0;
                this.tempPlaced.forEach(t => score += t.tile.score);
                score += 10; // å¥–åŠ±åˆ†

                // 3. æäº¤æ•°æ®
                const me = this.players[this.myIndex];
                me.score += score;
                me.misses = 0;
                
                const boardUpdate = {};
                // è·å–ä¹‹å‰æ‰€æœ‰é”å®šçš„ç‰Œ
                for(let r=0; r<15; r++) for(let c=0; c<15; c++) 
                    if(this.boardState[r][c]) boardUpdate[`${r},${c}`] = this.boardState[r][c];
                // åŠ ä¸Šæ–°çš„ç‰Œ
                this.tempPlaced.forEach(t => boardUpdate[`${t.r},${t.c}`] = t.tile);

                // è¡¥ç‰Œ
                const needed = 8 - me.rack.length;
                const newTiles = this.drawTiles(needed);
                me.rack.push(...newTiles);

                const nextIdx = (this.currentTurnIndex + 1) % this.players.length;
                this.tempPlaced = []; // æœ¬åœ°æ¸…ç©ºï¼Œç­‰å¾… Firebase æ¨é€å›æ¥

                try {
                    await updateDoc(getRoomRef(currentRoomId), {
                        board: boardUpdate,
                        players: this.players,
                        currentTurnIndex: nextIdx,
                        bags: { number: this.numberBag, operator: this.operatorBag }
                    });
                } catch(e) { alert("æäº¤å¤±è´¥: " + e.message); }
            }

            async passTurn() {
                await this.recallAll();
                const nextIdx = (this.currentTurnIndex + 1) % this.players.length;
                await updateDoc(getRoomRef(currentRoomId), { currentTurnIndex: nextIdx });
            }
        }

        // ç»‘å®šæŒ‰é’®
        window.btnPlay = () => localGame.submitTurn();
        window.btnPass = () => localGame.passTurn();
        window.btnReset = () => localGame.recallAll();
        window.btnSwap = () => alert("è”æœºç‰ˆæš‚ä¸æ”¯æŒæ¢ç‰Œï¼Œè¯·ä½¿ç”¨è·³è¿‡");
        window.game = { 
            showTutorial: () => document.getElementById('tutorial-modal').style.display = 'flex' 
        };

    </script>
</head>
<body>

    <!-- å¤§å…è¦†ç›–å±‚ -->
    <div id="lobby-screen">
        <div class="lobby-card">
            <h1 style="color:#ffd700; margin-top:0;">G-MATHå¤šäººè”æœºç‰ˆ</h1>
            <input type="text" id="player-name" class="lobby-input" placeholder="è¾“å…¥ä½ çš„æ˜µç§°" maxlength="8">
            <div style="display:flex; gap:10px;">
                <button id="btn-create" class="lobby-btn btn-create" onclick="createRoom()" disabled>åˆ›å»ºæˆ¿é—´</button>
            </div>
            <div style="margin: 20px 0; border-top:1px solid rgba(255,255,255,0.1); padding-top:20px;">
                <input type="number" id="room-id-input" class="lobby-input" placeholder="è¾“å…¥ 4 ä½æˆ¿é—´å·">
                <button id="btn-join" class="lobby-btn btn-join" onclick="joinRoom()" disabled>åŠ å…¥æˆ¿é—´</button>
            </div>
            <p style="color:#888; font-size:0.8rem;">è¿æ¥æœåŠ¡å™¨ä¸­...</p>
        </div>
    </div>

    <!-- æ¸¸æˆä¸»ç•Œé¢ -->
    <div id="game-container">
        <header>
            <h1>G-MATH <span id="room-id-display" onclick="copyRoomId()">ID: <span id="room-id-text">0000</span> ğŸ“‹</span></h1>
            <div style="font-size: 0.9rem; color: #ccc;">
                å‰©ä½™: <span id="tiles-left-header" style="font-weight:bold; color:white;">0</span>
            </div>
        </header>

        <div class="main-wrapper">
            <div class="board-area">
                <div id="game-board"></div>
            </div>

            <div class="sidebar">
                <!-- ç­‰å¾…å¼€å§‹é®ç½© -->
                <div id="waiting-overlay" style="background:rgba(0,0,0,0.5); padding:15px; border-radius:8px; display:none; flex-direction:column; align-items:center;">
                    <h3>ğŸ‘¥ ç­‰å¾…ç©å®¶åŠ å…¥...</h3>
                    <ul id="player-list-wait" style="list-style:none; padding:0; text-align:center; margin-bottom:15px;"></ul>
                    <button id="btn-start-game" onclick="startGame()" style="background:#2a9d8f; padding:10px 30px;">å¼€å§‹æ¸¸æˆ</button>
                </div>

                <div id="message-area">æ¬¢è¿æ¥åˆ° G-MATH!</div>

                <div class="panel score-board">
                    <h4 style="border-bottom:1px solid rgba(255,255,255,0.2); padding-bottom:5px;">
                        ğŸ“Š ç©å®¶ç§¯åˆ†
                    </h4>
                    <div id="players-list"></div>
                </div>

                <div class="panel">
                    <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:5px;">
                        <div style="font-weight:bold; color:#ddd;">ğŸ–ï¸ ä½ çš„æ‰‹ç‰Œ:</div>
                        <div style="font-size:0.8em; color:#aaa;" id="rack-hint">(ç‚¹å‡»é€‰ä¸­ï¼Œå†ç‚¹æ£‹ç›˜)</div>
                    </div>
                    <div id="rack-container"></div>
                </div>

                <div class="actions">
                    <button class="btn-play" onclick="btnPlay()">âœ… ç¡®è®¤å‡ºç‰Œ</button>
                    <button class="btn-swap" onclick="btnSwap()">â™»ï¸ æ¢ç‰Œ</button>
                    <button class="btn-reset" onclick="btnReset()">â†©ï¸ æ”¶å›</button>
                    <button class="btn-pass" onclick="btnPass()">â­ï¸ è·³è¿‡</button>
                    <button class="btn-help" onclick="game.showTutorial()">â“ è¯´æ˜</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal: Game Over -->
    <div id="modal" class="modal">
        <div class="modal-content" style="max-width: 500px;">
            <h2 id="modal-title" style="margin-top:0">ğŸ† æ¸¸æˆç»“æŸ</h2>
            <div id="modal-msg"></div>
            <button onclick="location.reload()" style="background:#2a9d8f; color:white; padding:15px 30px; font-size:1.1rem; margin-top: 20px;">è¿”å›å¤§å…</button>
        </div>
    </div>

    <!-- Modal: Tutorial -->
    <div id="tutorial-modal" class="modal">
        <div class="modal-content" style="text-align:left; max-width: 650px;">
            <span class="close-btn" onclick="document.getElementById('tutorial-modal').style.display='none'">&times;</span>
            <h2 style="text-align:center; margin-top:0; color:#4a4e69;">ğŸ“– G-MATH æ¸¸æˆæŒ‡å—</h2>
            <div class="tutorial-section">
                <h3>ğŸ¯ æ¸¸æˆç›®æ ‡</h3>
                <p>åˆ©ç”¨æ‰‹ä¸­çš„æ•°å­—å’Œç¬¦å·ç‰Œï¼Œåœ¨æ£‹ç›˜ä¸Šæ‹¼å‡º<strong>æ­£ç¡®çš„æ•°å­¦ç­‰å¼</strong>ï¼</p>
            </div>
            <div class="tutorial-section">
                <h3>ğŸ•¹ï¸ ç©æ³•</h3>
                <ul class="tutorial-list">
                    <li>é¦–ä½ç©å®¶å¿…é¡»è¦†ç›–ä¸­å¿ƒæ˜Ÿå·ã€‚</li>
                    <li>ç‰Œå¿…é¡»ç›¸è¿ï¼Œå¹¶ç»„æˆæœ‰æ•ˆç­‰å¼ (å¦‚ 2+3=5)ã€‚</li>
                    <li>ç‰Œå¿…é¡»åŒ…å«è‡³å°‘ä¸€ä¸ª "=" å·ã€‚</li>
                </ul>
            </div>
        </div>
    </div>

</body>
</html>
