<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>G-MATH Online - Â§ö‰∫∫ËÅîÊú∫Áâà</title>
    <style>
        :root {
            --board-bg: #f0f0f0;
            --tile-bg: #fdf5e6;
            --tile-color: #333;
            --dl-color: #a8e6cf;
            --tl-color: #3d84a8;
            --dw-color: #ffaaa5;
            --tw-color: #ff8b94;
            --accent: #4a4e69;
            --dark-bg: #22223b;
            --cell-size-desktop: 38px;
        }

        * { box-sizing: border-box; }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: var(--dark-bg);
            color: white;
            margin: 0;
            padding: 0;
            min-height: 100vh;
            overflow-y: auto; 
            display: flex;
            flex-direction: column;
        }

        /* === Â§ßÂéÖÁïåÈù¢Ê†∑Âºè === */
        #lobby-screen {
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            background: var(--dark-bg);
            z-index: 2000;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            padding: 20px;
        }
        .lobby-card {
            background: rgba(255,255,255,0.1);
            backdrop-filter: blur(10px);
            padding: 30px;
            border-radius: 15px;
            width: 100%;
            max-width: 400px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.5);
            text-align: center;
        }
        .lobby-input {
            width: 100%;
            padding: 12px;
            margin: 10px 0;
            border-radius: 8px;
            border: 1px solid #555;
            background: rgba(0,0,0,0.3);
            color: white;
            font-size: 1rem;
        }
        .lobby-btn {
            width: 100%;
            padding: 12px;
            margin: 5px 0;
            border: none;
            border-radius: 8px;
            font-size: 1rem;
            font-weight: bold;
            cursor: pointer;
            transition: transform 0.1s;
        }
        .btn-create { background: #2a9d8f; color: white; }
        .btn-join { background: #e9c46a; color: #333; }
        
        #room-info-panel {
            margin-top: 20px;
            padding: 15px;
            background: rgba(0,0,0,0.2);
            border-radius: 8px;
            display: none;
        }

        /* === Ê∏∏ÊàèÁïåÈù¢ === */
        #game-container { display: none; flex-direction: column; height: 100%; }

        header {
            height: 50px;
            background: #1a1a2e;
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0 20px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
            flex-shrink: 0;
            z-index: 20;
        }

        .main-wrapper {
            flex: 1;
            display: flex;
            padding: 10px;
            width: 100%;
            flex-wrap: wrap;
            justify-content: center;
            gap: 15px;
        }

        /* === Ê£ãÁõòÂå∫Âüü === */
        .board-area {
            flex-shrink: 0;
            background: #4a4e69;
            padding: 8px;
            border-radius: 8px;
            box-shadow: 5px 5px 20px rgba(0,0,0,0.4);
            display: flex;
            justify-content: center;
            align-items: center;
        }

        #game-board {
            display: grid;
            grid-template-columns: repeat(15, var(--cell-size, 38px));
            grid-template-rows: repeat(15, var(--cell-size, 38px));
            gap: 2px;
            background-color: #333;
            border: 2px solid #333;
        }

        .cell {
            width: var(--cell-size, 38px);
            height: var(--cell-size, 38px);
            background-color: var(--board-bg);
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: calc(var(--cell-size, 38px) * 0.35);
            color: #333;
            font-weight: bold;
            position: relative;
            user-select: none;
        }

        .cell.dl { background-color: var(--dl-color); color: #004d40; }
        .cell.tl { background-color: var(--tl-color); color: white; }
        .cell.dw { background-color: var(--dw-color); color: #880e4f; }
        .cell.tw { background-color: var(--tw-color); color: #880e4f; }
        .cell.center { background-color: var(--dw-color); font-size: calc(var(--cell-size, 38px) * 0.6); }

        /* ÁâåÊ†∑Âºè */
        .tile {
            width: calc(var(--cell-size, 38px) - 4px);
            height: calc(var(--cell-size, 38px) - 4px);
            background-color: var(--tile-bg);
            border-radius: 4px;
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: calc(var(--cell-size, 38px) * 0.6);
            font-weight: bold;
            color: var(--tile-color);
            box-shadow: 2px 2px 4px rgba(0,0,0,0.2);
            cursor: grab;
            z-index: 10;
            position: relative;
        }
        .tile span.points {
            position: absolute;
            bottom: 1px;
            right: 2px;
            font-size: 0.5em;
            color: #666;
        }
        .tile.temp { border: 2px solid #4caf50; box-shadow: 0 0 5px #4caf50; }
        .tile.locked { cursor: default; background-color: #e0e0e0; color: #555; }
        .tile.selected {
            transform: translateY(-5px) scale(1.1);
            border: 2px solid #ffd700;
            box-shadow: 0 0 10px rgba(255, 215, 0, 0.8);
            z-index: 20;
            background-color: #fffbf0;
        }
        .tile.disabled { opacity: 0.7; cursor: not-allowed; }

        /* === ‰æßËæπÊ†è === */
        .sidebar {
            display: flex;
            flex-direction: column;
            gap: 10px;
            min-width: 300px;
            max-width: 400px;
            flex: 1;
        }

        .panel {
            background: rgba(255,255,255,0.07);
            padding: 10px 15px;
            border-radius: 12px;
            border: 1px solid rgba(255,255,255,0.1);
        }

        #rack-container {
            background: rgba(0,0,0,0.3);
            padding: 10px;
            border-radius: 10px;
            min-height: 60px;
            display: flex;
            gap: 8px;
            justify-content: center;
            align-items: center;
            flex-wrap: wrap;
            border: 2px dashed rgba(255,255,255,0.1);
        }
        
        #rack-container .tile { cursor: pointer; }

        /* ÁßØÂàÜÊ¶ú */
        .player-score {
            display: flex;
            justify-content: space-between;
            padding: 8px 10px;
            font-size: 0.95rem;
            border-bottom: 1px solid rgba(255,255,255,0.05);
        }
        .player-score.active { 
            border-left: 4px solid #ffd700;
            background: linear-gradient(90deg, rgba(255,215,0,0.1), transparent);
            color: #ffd700;
        }
        .player-score.me {
             font-weight: bold;
             background: rgba(42, 157, 143, 0.2);
        }

        /* ÊåâÈíÆÁªÑ */
        .actions { 
            display: grid; 
            grid-template-columns: repeat(3, 1fr);
            gap: 8px; 
        }
        button {
            padding: 12px 5px;
            border: none;
            border-radius: 8px;
            font-weight: bold;
            cursor: pointer;
            font-size: 0.9rem;
            color: white;
        }
        button:disabled { opacity: 0.4; cursor: not-allowed; }
        
        .btn-play { background: #2a9d8f; grid-column: span 3; font-size: 1.1rem; }
        .btn-swap { background: #e9c46a; color: #333; }
        .btn-reset { background: #e76f51; }
        .btn-pass { background: #264653; }

        #message-area {
            text-align: center;
            color: #ffd700;
            font-weight: bold;
            padding: 8px;
            background: rgba(0,0,0,0.4);
            border-radius: 6px;
            min-height: 36px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        #room-id-display {
            font-family: monospace;
            background: rgba(0,0,0,0.5);
            padding: 2px 8px;
            border-radius: 4px;
            color: #4cc9f0;
            cursor: pointer;
            margin-left: 10px;
        }

        /* ÂìçÂ∫îÂºè */
        @media (max-width: 768px) {
            :root { --cell-size: calc((100vw - 26px) / 15); }
            .main-wrapper { flex-direction: column; align-items: center; }
            .sidebar { width: 100%; max-width: none; }
            .board-area { padding: 2px; }
            h1 { font-size: 1rem; }
        }
    </style>

    <!-- ÂºïÂÖ• Firebase SDK -->
    <script type="module">
        // ÂØºÂÖ•ÂøÖË¶ÅÁöÑ SDK ÂáΩÊï∞ (‰ΩøÁî®Áªü‰∏ÄÁöÑÁ®≥ÂÆöÁâàÊú¨)
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getFirestore, doc, setDoc, getDoc, onSnapshot, updateDoc, arrayUnion, deleteDoc, collection } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";

        // === ‰Ω†ÁöÑ Firebase ÈÖçÁΩÆ (Â∑≤Â°´ÂÖ•) ===
        const firebaseConfig = {
            apiKey: "AIzaSyDG8QBOaVkG2X2q04dyG0wVe-vYvsOVAdQ",
            authDomain: "g-math-pvp-35665.firebaseapp.com",
            projectId: "g-math-pvp-35665",
            storageBucket: "g-math-pvp-35665.firebasestorage.app",
            messagingSenderId: "715488897072",
            appId: "1:715488897072:web:88c73bf50912fd6c90e5f5",
            measurementId: "G-63SZM7FYCZ"
        };

        // ÂàùÂßãÂåñ Firebase
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);

        // ÂÖ®Â±ÄÂèòÈáè
        let myUid = null;
        let myName = "Player";
        let currentRoomId = null;
        let unsubscribeRoom = null;
        let localGame = null;

        // === 1. ÁôªÂΩïÈÄªËæë (ÂåøÂêçÁôªÂΩï) ===
        // Á°Æ‰øù‰Ω†Âú® Firebase ÊéßÂà∂Âè∞ -> Authentication -> Sign-in method ‰∏≠ÂºÄÂêØ‰∫Ü‚ÄúÂåøÂêç(Anonymous)‚Äù
        signInAnonymously(auth).then(() => {
            console.log("Â∑≤ËøûÊé•Âà∞ Firebase ÊúçÂä°Âô®");
        }).catch((error) => {
            console.error("ÁôªÂΩïÂ§±Ë¥•:", error);
            let msg = "ËøûÊé•ÊúçÂä°Âô®Â§±Ë¥•";
            if (error.code === 'auth/admin-restricted-operation' || error.code === 'auth/operation-not-allowed') {
                msg += " (ËØ∑Âú® Firebase ÊéßÂà∂Âè∞ÂºÄÂêØÂåøÂêçÁôªÂΩï)";
            } else {
                msg += ": " + error.message;
            }
            alert(msg);
            document.getElementById('message-area').innerText = msg;
        });

        onAuthStateChanged(auth, (user) => {
            if (user) {
                myUid = user.uid;
                // ÁôªÂΩïÊàêÂäüÂêéÊâçÂêØÁî®ÊåâÈíÆ
                document.getElementById('btn-create').disabled = false;
                document.getElementById('btn-join').disabled = false;
                console.log("User authenticated:", myUid);
            }
        });

        // ËæÖÂä©ÂáΩÊï∞ÔºöËé∑ÂèñÊàøÈó¥ÁöÑ Document Reference
        // ËøôÈáåÁÆÄÂåñ‰∫ÜË∑ØÂæÑÔºåÁõ¥Êé•ÊîæÂú®Ê†πÁõÆÂΩï 'rooms' ÈõÜÂêà‰∏ãÔºåÊñπ‰æø‰Ω†ÁÆ°ÁêÜ
        function getRoomRef(roomId) {
            return doc(db, 'rooms', roomId);
        }

        // === Â§ßÂéÖÈÄªËæë ===
        window.createRoom = async () => {
            if (!auth.currentUser) return alert("Ê≠£Âú®ËøûÊé•ÊúçÂä°Âô®ÔºåËØ∑Á®çÂÄô...");
            const nameInput = document.getElementById('player-name').value.trim();
            if (!nameInput) return alert("ËØ∑ËæìÂÖ•ÊòµÁß∞");
            myName = nameInput;

            // ÁîüÊàê4‰ΩçÈöèÊú∫ÊàøÈó¥Âè∑
            const roomId = Math.floor(1000 + Math.random() * 9000).toString();
            const roomRef = getRoomRef(roomId);
            
            // ÂàùÂßãÂåñÊ∏∏ÊàèÊï∞ÊçÆ
            const initialGame = new GameEngine(); 
            const gameData = initialGame.serialize();
            
            // Ê∑ªÂä†Á¨¨‰∏Ä‰∏™Áé©ÂÆ∂ (Êàø‰∏ª)
            gameData.players.push({
                uid: myUid,
                name: myName,
                score: 0,
                rack: initialGame.drawTiles(7), // ÂàùÂßã7Âº†
                active: true,
                misses: 0
            });
            gameData.bags = { number: initialGame.numberBag, operator: initialGame.operatorBag };

            try {
                await setDoc(roomRef, gameData);
                enterRoom(roomId);
            } catch (e) {
                console.error(e);
                alert("ÂàõÂª∫ÊàøÈó¥Â§±Ë¥•: " + e.message + "\nËØ∑Ê£ÄÊü• Firestore ËßÑÂàôÊòØÂê¶ÂÖÅËÆ∏ËØªÂÜô„ÄÇ");
            }
        };

        window.joinRoom = async () => {
            if (!auth.currentUser) return alert("Ê≠£Âú®ËøûÊé•ÊúçÂä°Âô®ÔºåËØ∑Á®çÂÄô...");
            const nameInput = document.getElementById('player-name').value.trim();
            const roomInput = document.getElementById('room-id-input').value.trim();
            if (!nameInput || !roomInput) return alert("ËØ∑ËæìÂÖ•ÊòµÁß∞ÂíåÊàøÈó¥Âè∑");
            myName = nameInput;

            const roomRef = getRoomRef(roomInput);
            
            try {
                const docSnap = await getDoc(roomRef);
                if (!docSnap.exists()) return alert("ÊàøÈó¥‰∏çÂ≠òÂú®");
                
                const data = docSnap.data();
                if (data.status !== 'waiting' && !data.players.find(p => p.uid === myUid)) {
                    return alert("Ê∏∏ÊàèÂ∑≤ÂºÄÂßãÊàñÂ∑≤ÁªìÊùü");
                }

                if (data.players.length >= 4 && !data.players.find(p => p.uid === myUid)) {
                    return alert("ÊàøÈó¥Â∑≤Êª°");
                }

                // Â¶ÇÊûúÊàëÂ∑≤ÁªèÂú®‰∫ÜÔºåÁõ¥Êé•ËøõÂÖ•ÔºõÂê¶ÂàôÊõ¥Êñ∞‰∫ëÁ´ØÂä†ÂÖ•ÂàóË°®
                if (!data.players.find(p => p.uid === myUid)) {
                    const updatedPlayers = [...data.players, {
                        uid: myUid,
                        name: myName,
                        score: 0,
                        rack: [], // ÊöÇÊó∂Á©∫ÔºåÁ≠âÂæÖÂêéÁª≠ÂêåÊ≠•Ë°•Áâå
                        active: true,
                        misses: 0
                    }];
                    
                    await updateDoc(roomRef, { players: updatedPlayers });
                }
                enterRoom(roomInput);
            } catch (e) {
                console.error("Join Error:", e);
                alert("Âä†ÂÖ•ÊàøÈó¥Â§±Ë¥•: " + e.message);
            }
        };

        function enterRoom(roomId) {
            currentRoomId = roomId;
            document.getElementById('lobby-screen').style.display = 'none';
            document.getElementById('game-container').style.display = 'flex';
            document.getElementById('room-id-text').innerText = roomId;
            
            // ÁõëÂê¨ÊàøÈó¥Êõ¥Êñ∞
            unsubscribeRoom = onSnapshot(getRoomRef(roomId), (doc) => {
                if (doc.exists()) {
                    const data = doc.data();
                    handleGameUpdate(data);
                } else {
                    alert("ÊàøÈó¥Â∑≤Ëß£Êï£");
                    location.reload();
                }
            }, (error) => {
                console.error("Snapshot Error:", error);
                alert("ËøûÊé•‰∏≠Êñ≠: " + error.message);
            });

            // ÂàùÂßãÂåñÊú¨Âú∞Ê∏∏ÊàèÂºïÊìé
            localGame = new GameEngine();
            localGame.initUI();
        }

        window.copyRoomId = () => {
            if (navigator.clipboard && navigator.clipboard.writeText) {
                navigator.clipboard.writeText(currentRoomId)
                    .then(() => alert("ÊàøÈó¥Âè∑Â∑≤Â§çÂà∂: " + currentRoomId))
                    .catch(() => alert("Â§çÂà∂Â§±Ë¥•ÔºåËØ∑ÊâãÂä®Â§çÂà∂"));
            } else {
                // Fallback
                const textArea = document.createElement("textarea");
                textArea.value = currentRoomId;
                document.body.appendChild(textArea);
                textArea.select();
                try {
                    document.execCommand('copy');
                    alert("ÊàøÈó¥Âè∑Â∑≤Â§çÂà∂: " + currentRoomId);
                } catch (err) {
                    alert("Â§çÂà∂Â§±Ë¥•");
                }
                document.body.removeChild(textArea);
            }
        };

        window.startGame = async () => {
            if (!currentRoomId) return;
            const roomRef = getRoomRef(currentRoomId);
            await updateDoc(roomRef, { status: 'playing' });
        };

        // === Ê∏∏ÊàèÊ†∏ÂøÉÈÄªËæëÊï¥Âêà ===
        
        async function handleGameUpdate(data) {
            const myPlayerIndex = data.players.findIndex(p => p.uid === myUid);
            const isHost = (myPlayerIndex === 0);
            
            // Ëá™Âä®Ë°•ÁâåÈÄªËæëÔºöÂ¶ÇÊûúÊàëÊúâÁ©∫ÊâãÁâå‰∏îÁâåÂ∫ìÊúâÁâå
            if (myPlayerIndex !== -1 && data.players[myPlayerIndex].rack.length === 0 && data.status !== 'finished') {
                const totalBag = data.bags.number.length + data.bags.operator.length;
                if (totalBag > 0) {
                    // Êú¨Âú∞ËÆ°ÁÆóË°•Áâå
                    localGame.syncFromCloud(data);
                    const newTiles = localGame.drawTiles(7);
                    
                    // Ê∑±Êã∑Ë¥ù‰øÆÊîπ
                    const newPlayers = JSON.parse(JSON.stringify(data.players));
                    newPlayers[myPlayerIndex].rack = newTiles;
                    
                    const newBags = { 
                        number: localGame.numberBag, 
                        operator: localGame.operatorBag 
                    };
                    
                    // ÂÜôÂõû‰∫ëÁ´Ø
                    await updateDoc(getRoomRef(currentRoomId), {
                        players: newPlayers,
                        bags: newBags
                    });
                    return; // Á≠âÂæÖ‰∏ã‰∏ÄÊ¨°Êé®ÈÄÅ
                }
            }

            // Êõ¥Êñ∞Êú¨Âú∞Áä∂ÊÄÅ
            localGame.syncFromCloud(data);
            localGame.myIndex = myPlayerIndex;
            localGame.render();

            // Áä∂ÊÄÅÂà§Êñ≠
            const waitingEl = document.getElementById('waiting-overlay');
            if (data.status === 'waiting') {
                waitingEl.style.display = 'flex';
                document.getElementById('player-list-wait').innerHTML = data.players.map(p => `<li>${p.name}</li>`).join('');
                // Âè™ÊúâÊàø‰∏ªÊòæÁ§∫ÂºÄÂßãÊåâÈíÆ
                document.getElementById('btn-start-game').style.display = isHost ? 'block' : 'none';
            } else {
                waitingEl.style.display = 'none';
            }

            if (data.status === 'finished') {
                alert("Ê∏∏ÊàèÁªìÊùüÔºÅ");
            }
        }

        // Ê∏∏ÊàèÂºïÊìéÁ±ª (ÈÄªËæë + Ê∏≤Êüì)
        class GameEngine {
            constructor() {
                this.boardState = Array(15).fill(null).map(() => Array(15).fill(null));
                this.players = [];
                this.numberBag = [];
                this.operatorBag = [];
                this.currentTurnIndex = 0;
                this.myIndex = -1;
                this.tempPlaced = []; // Êú¨Âú∞‰∏¥Êó∂ÊîæÁΩÆÁöÑÁâå {r,c,tile}
                this.selectedTileId = null;
                this.isSwapping = false;
                
                // ÁîüÊàêÂàùÂßãÁâåÂ∫ì
                this.generateTileBag();
                this.shuffleBag();
            }

            serialize() {
                return {
                    status: 'waiting',
                    currentTurnIndex: 0,
                    players: [],
                    board: {}, // Á®ÄÁñèÂ≠òÂÇ® "r,c": tileData
                    bags: { number: this.numberBag, operator: this.operatorBag }
                };
            }

            syncFromCloud(data) {
                this.players = data.players;
                this.currentTurnIndex = data.currentTurnIndex;
                // Ê∑±Êã∑Ë¥ùÈò≤Ê≠¢ÂºïÁî®Ê±°Êüì
                this.numberBag = JSON.parse(JSON.stringify(data.bags.number));
                this.operatorBag = JSON.parse(JSON.stringify(data.bags.operator));
                
                // ËøòÂéüÊ£ãÁõò
                this.boardState = Array(15).fill(null).map(() => Array(15).fill(null));
                for (let key in data.board) {
                    const [r, c] = key.split(',').map(Number);
                    this.boardState[r][c] = data.board[key];
                }
            }

            generateTileBag() {
                const DIST = {
                    '0':6, '1':6, '2':6, '3':6, '4':6, '5':6, '6':6, '7':6, '8':6, '9':6,
                    '+':7, '-':7, '√ó':7, '√∑':7, '=':20
                };
                const SCORES = {
                    '0':1, '1':1, '2':2, '3':2, '4':2, '5':3, '6':3, '7':4, '8':4, '9':4,
                    '+':2, '-':2, '√ó':4, '√∑':4, '=':1
                };
                let id = 0;
                for (let char in DIST) {
                    for(let i=0; i<DIST[char]; i++) {
                        const tile = { id: id++, char, score: SCORES[char] };
                        if (/\d/.test(char)) this.numberBag.push(tile);
                        else this.operatorBag.push(tile);
                    }
                }
            }

            shuffleBag() {
                const s = (arr) => arr.sort(() => Math.random() - 0.5);
                s(this.numberBag);
                s(this.operatorBag);
            }

            drawTiles(count) {
                let drawn = [];
                for(let i=0; i<count; i++) {
                    if (this.numberBag.length > 0 && (Math.random() > 0.4 || this.operatorBag.length === 0)) {
                        drawn.push(this.numberBag.pop());
                    } else if (this.operatorBag.length > 0) {
                        drawn.push(this.operatorBag.pop());
                    }
                }
                return drawn;
            }

            // === UI Ê∏≤Êüì ===
            initUI() {
                const boardEl = document.getElementById('game-board');
                boardEl.innerHTML = '';
                const SPECIAL = {
                    'TW': ['0,0', '0,7', '0,14', '7,0', '7,14', '14,0', '14,7', '14,14'],
                    'DW': ['1,1', '2,2', '3,3', '4,4', '10,10', '11,11', '12,12', '13,13', '1,13', '2,12', '3,11', '4,10', '10,4', '11,3', '12,2', '13,1'],
                    'TL': ['1,5', '1,9', '5,1', '5,5', '5,9', '5,13', '9,1', '9,5', '9,9', '9,13', '13,5', '13,9'],
                    'DL': ['0,3', '0,11', '2,6', '2,8', '3,0', '3,7', '3,14', '6,2', '6,6', '6,8', '6,12', '7,3', '7,11', '8,2', '8,6', '8,8', '8,12', '11,0', '11,7', '11,14', '12,6', '12,8', '14,3', '14,11']
                };

                for (let r = 0; r < 15; r++) {
                    for (let c = 0; c < 15; c++) {
                        const cell = document.createElement('div');
                        cell.className = 'cell';
                        cell.dataset.r = r;
                        cell.dataset.c = c;
                        const key = `${r},${c}`;
                        if (r===7&&c===7) { cell.classList.add('center'); cell.innerHTML='‚òÖ'; }
                        else if (SPECIAL.TW.includes(key)) { cell.classList.add('tw'); cell.innerText='TW'; }
                        else if (SPECIAL.DW.includes(key)) { cell.classList.add('dw'); cell.innerText='DW'; }
                        else if (SPECIAL.TL.includes(key)) { cell.classList.add('tl'); cell.innerText='TL'; }
                        else if (SPECIAL.DL.includes(key)) { cell.classList.add('dl'); cell.innerText='DL'; }
                        
                        cell.onclick = () => this.handleBoardClick(r, c);
                        boardEl.appendChild(cell);
                    }
                }
            }

            render() {
                // 1. Ê∏≤ÊüìÊ£ãÁõò
                for(let r=0; r<15; r++) {
                    for(let c=0; c<15; c++) {
                        this.updateCell(r, c);
                    }
                }
                
                // 2. Ê∏≤ÊüìÊàëÁöÑÊâãÁâå
                const rackEl = document.getElementById('rack-container');
                rackEl.innerHTML = '';
                if (this.myIndex !== -1 && this.players[this.myIndex]) {
                    this.players[this.myIndex].rack.forEach(tile => {
                        const t = this.createTileDom(tile);
                        t.onclick = (e) => {
                            e.stopPropagation();
                            this.handleRackClick(tile);
                        }
                        if (this.selectedTileId === tile.id) t.classList.add('selected');
                        if (this.isSwapping && this.selectedTileId === tile.id) t.classList.add('selected'); 
                        rackEl.appendChild(t);
                    });
                }

                // 3. Ê∏≤Êüì‰ø°ÊÅØ
                const isMyTurn = this.currentTurnIndex === this.myIndex;
                const turnPlayer = this.players[this.currentTurnIndex];
                const msgArea = document.getElementById('message-area');
                
                if (this.players.length > 0) {
                    if (isMyTurn) {
                        msgArea.innerText = "üëâ ËΩÆÂà∞‰Ω†‰∫ÜÔºÅËØ∑Âá∫Áâå";
                        msgArea.style.color = "#ffd700";
                    } else {
                        msgArea.innerText = `‚è≥ Á≠âÂæÖ ${turnPlayer ? turnPlayer.name : '...'} Âá∫Áâå`;
                        msgArea.style.color = "#ccc";
                    }
                }

                // ÊåâÈíÆÁä∂ÊÄÅ
                document.querySelectorAll('.actions button').forEach(b => b.disabled = !isMyTurn);
                
                // 4. Ê∏≤ÊüìÁßØÂàÜÊ¶ú
                const list = document.getElementById('players-list');
                list.innerHTML = '';
                this.players.forEach((p, i) => {
                    const div = document.createElement('div');
                    div.className = `player-score ${i === this.currentTurnIndex ? 'active' : ''} ${i === this.myIndex ? 'me' : ''}`;
                    div.innerHTML = `<span>${i===this.myIndex ? 'üë§' : ''} ${p.name}</span> <span>${p.score}</span>`;
                    list.appendChild(div);
                });
            }

            updateCell(r, c) {
                const cell = document.querySelector(`.cell[data-r="${r}"][data-c="${c}"]`);
                if (!cell) return;
                
                const lockedTile = this.boardState[r][c];
                const tempTileObj = this.tempPlaced.find(t => t.r === r && t.c === c);
                
                const oldTile = cell.querySelector('.tile');
                if (oldTile) oldTile.remove();

                if (lockedTile) {
                    const t = this.createTileDom(lockedTile);
                    t.classList.add('locked');
                    cell.appendChild(t);
                } else if (tempTileObj) {
                    const t = this.createTileDom(tempTileObj.tile);
                    t.classList.add('temp');
                    t.onclick = (e) => {
                        e.stopPropagation();
                        this.recallTempTile(tempTileObj);
                    };
                    cell.appendChild(t);
                }
            }

            createTileDom(tileData) {
                const el = document.createElement('div');
                el.className = 'tile';
                el.innerHTML = `${tileData.char}<span class="points">${tileData.score}</span>`;
                return el;
            }

            // === ‰∫§‰∫íÈÄªËæë ===
            handleRackClick(tile) {
                if (this.currentTurnIndex !== this.myIndex) return;
                if (this.isSwapping) {
                     this.selectedTileId = tile.id;
                     this.render();
                     return;
                }
                
                // ÈÄâ‰∏≠Áä∂ÊÄÅÂàáÊç¢
                if (this.selectedTileId === tile.id) this.selectedTileId = null;
                else this.selectedTileId = tile.id;
                this.render();
            }

            handleBoardClick(r, c) {
                if (this.currentTurnIndex !== this.myIndex) return;
                if (this.boardState[r][c]) return; // Â∑≤ÊúâÈîÅÂÆöÁöÑÁâå
                
                // ÊîæÁΩÆÁâå
                if (this.selectedTileId !== null) {
                    const rack = this.players[this.myIndex].rack;
                    const tileIdx = rack.findIndex(t => t.id === this.selectedTileId);
                    if (tileIdx === -1) return;
                    
                    const tile = rack[tileIdx];
                    
                    // ÁßªÂä®Êï∞ÊçÆ: Rack -> Temp
                    this.players[this.myIndex].rack.splice(tileIdx, 1);
                    this.tempPlaced.push({ r, c, tile });
                    this.selectedTileId = null;
                    this.render();
                }
            }

            recallTempTile(tempObj) {
                if (this.currentTurnIndex !== this.myIndex) return;
                // Temp -> Rack
                const idx = this.tempPlaced.indexOf(tempObj);
                if (idx > -1) {
                    this.tempPlaced.splice(idx, 1);
                    this.players[this.myIndex].rack.push(tempObj.tile);
                    this.render();
                }
            }

            async recallAll() {
                // ÂøÖÈ°ª‰ªéÂêéÂæÄÂâçÂà†ÊàñÂ§çÂà∂Êï∞ÁªÑÔºåÂõ†‰∏∫ splice ‰ºöÊîπÂèòÊï∞ÁªÑ
                const tempCopy = [...this.tempPlaced];
                tempCopy.forEach(t => this.recallTempTile(t));
                this.tempPlaced = [];
                this.render();
            }

            // === Ê†∏ÂøÉÔºöÊèê‰∫§ÂõûÂêà ===
            async submitTurn() {
                if (this.tempPlaced.length === 0) return alert("ËØ∑ÂÖàÂá∫Áâå");
                
                // ÁÆÄÂçïÈ™åËØÅËßÑÂàô (ÂÆûÈôÖÈ°πÁõÆËØ∑ÊõøÊç¢‰∏∫ÂÆåÊï¥ÁöÑÁÆóÊ≥ï)
                const score = this.calculateScore(); 
                if (score === -1) return alert("Âá∫Áâå‰∏çÁ¨¶ÂêàËßÑÂàô (ÈúÄËøûÊàê‰∏ÄÁ∫ø‰∏îÊûÑÊàêÊúâÊïàÁ≠âÂºèÔºåÂê´=Âè∑)");

                const myPlayer = this.players[this.myIndex];
                myPlayer.score += score;
                
                // Â∞Ü temp ËΩ¨‰∏∫ locked
                this.tempPlaced.forEach(t => {
                    this.boardState[t.r][t.c] = t.tile;
                });
                
                const boardUpdate = {};
                for(let r=0; r<15; r++) {
                    for(let c=0; c<15; c++) {
                        if (this.boardState[r][c]) {
                            boardUpdate[`${r},${c}`] = this.boardState[r][c];
                        }
                    }
                }

                // Ë°•Áâå
                const needed = 8 - myPlayer.rack.length;
                const newTiles = this.drawTiles(needed);
                myPlayer.rack.push(...newTiles);

                let nextIndex = (this.currentTurnIndex + 1) % this.players.length;
                this.tempPlaced = [];

                // 3. ÂÜôÂÖ• Firebase
                try {
                    await updateDoc(getRoomRef(currentRoomId), {
                        board: boardUpdate,
                        players: this.players,
                        currentTurnIndex: nextIndex,
                        bags: { number: this.numberBag, operator: this.operatorBag }
                    });
                } catch(e) {
                    alert("Êèê‰∫§Â§±Ë¥•: " + e.message);
                }
            }

            async passTurn() {
                await this.recallAll();
                let nextIndex = (this.currentTurnIndex + 1) % this.players.length;
                await updateDoc(getRoomRef(currentRoomId), {
                    currentTurnIndex: nextIndex
                });
            }

            calculateScore() {
                const tiles = this.tempPlaced.map(t => t.tile.char);
                if (!tiles.includes('=')) return -1;
                
                let pts = 0;
                this.tempPlaced.forEach(t => pts += t.tile.score);
                return pts + 10; // Âü∫Á°ÄÂàÜ+Â•ñÂä±ÂàÜ
            }
        }

        // ÁªëÂÆöÊåâÈíÆ‰∫ã‰ª∂
        window.btnPlay = () => localGame.submitTurn();
        window.btnPass = () => localGame.passTurn();
        window.btnReset = () => localGame.recallAll();
        window.btnSwap = () => alert("Êç¢ÁâåÂäüËÉΩÂú®Ê≠§ÊºîÁ§∫Áâà‰∏≠ÁÆÄÂåñÔºåËØ∑Áõ¥Êé•Ë∑≥Ëøá");

    </script>
</head>
<body>

    <!-- Â§ßÂéÖË¶ÜÁõñÂ±Ç -->
    <div id="lobby-screen">
        <div class="lobby-card">
            <h1 style="color:#ffd700; margin-top:0;">G-MATH Online üßÆ</h1>
            <input type="text" id="player-name" class="lobby-input" placeholder="ËæìÂÖ•‰Ω†ÁöÑÊòµÁß∞" maxlength="8">
            <div style="display:flex; gap:10px;">
                <button id="btn-create" class="lobby-btn btn-create" onclick="createRoom()" disabled>ÂàõÂª∫Êñ∞ÊàøÈó¥</button>
            </div>
            <div style="margin: 20px 0; border-top:1px solid rgba(255,255,255,0.1); padding-top:20px;">
                <input type="number" id="room-id-input" class="lobby-input" placeholder="ËæìÂÖ• 4 ‰ΩçÊàøÈó¥Âè∑">
                <button id="btn-join" class="lobby-btn btn-join" onclick="joinRoom()" disabled>Âä†ÂÖ•ÊàøÈó¥</button>
            </div>
            <p style="color:#888; font-size:0.8rem;">ËøûÊé•ÊúçÂä°Âô®‰∏≠...</p>
        </div>
    </div>

    <!-- Ê∏∏Êàè‰∏ªÁïåÈù¢ -->
    <div id="game-container">
        <header>
            <h1>G-MATH <span id="room-id-display" onclick="copyRoomId()">ID: <span id="room-id-text">0000</span> üìã</span></h1>
            <div id="message-area">ËøûÊé•‰∏≠...</div>
        </header>

        <div class="main-wrapper">
            <div class="board-area">
                <div id="game-board"></div>
            </div>

            <div class="sidebar">
                <!-- Á≠âÂæÖÂºÄÂßãÈÅÆÁΩ© -->
                <div id="waiting-overlay" style="background:rgba(0,0,0,0.5); padding:15px; border-radius:8px; display:none; flex-direction:column; align-items:center;">
                    <h3>üë• Á≠âÂæÖÁé©ÂÆ∂Âä†ÂÖ•...</h3>
                    <ul id="player-list-wait" style="list-style:none; padding:0; text-align:center; margin-bottom:15px;"></ul>
                    <button id="btn-start-game" onclick="startGame()" style="background:#2a9d8f; padding:10px 30px;">ÂºÄÂßãÊ∏∏Êàè</button>
                </div>

                <div class="panel" style="flex:1; display:flex; flex-direction:column;">
                    <h4 style="margin:0 0 10px 0; border-bottom:1px solid #555; padding-bottom:5px;">üìä ÂÆûÊó∂ÁßØÂàÜ</h4>
                    <div id="players-list"></div>
                </div>

                <div class="panel">
                    <div style="margin-bottom:5px; color:#aaa; font-size:0.9em;">üñêÔ∏è ‰Ω†ÁöÑÊâãÁâå</div>
                    <div id="rack-container"></div>
                </div>

                <div class="actions">
                    <button class="btn-play" onclick="btnPlay()">‚úÖ Á°ÆËÆ§Âá∫Áâå</button>
                    <button class="btn-swap" onclick="btnSwap()">‚ôªÔ∏è Êç¢Áâå</button>
                    <button class="btn-reset" onclick="btnReset()">‚Ü©Ô∏è Êî∂Âõû</button>
                    <button class="btn-pass" onclick="btnPass()">‚è≠Ô∏è Ë∑≥Ëøá</button>
                </div>
            </div>
        </div>
    </div>

</body>
</html>
