<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>G-MATH - æ•°å­¦æ‹¼å­—æ¸¸æˆ (Online)</title>
    <style>
        :root {
            --board-bg: #f0f0f0;
            --tile-bg: #fdf5e6;
            --tile-color: #333;
            --dl-color: #a8e6cf;
            --tl-color: #3d84a8;
            --dw-color: #ffaaa5;
            --tw-color: #ff8b94;
            --accent: #4a4e69;
            --dark-bg: #22223b;
        }

        * { box-sizing: border-box; }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: var(--dark-bg);
            color: white;
            margin: 0;
            padding: 0;
            height: auto;
            min-height: 100vh;
            overflow-y: auto; 
            display: flex;
            flex-direction: column;
        }

        /* === é¡¶éƒ¨å¯¼èˆª === */
        header {
            height: 50px;
            background: #1a1a2e;
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0 20px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
            flex-shrink: 0;
            z-index: 20;
            position: relative;
        }

        h1 {
            margin: 0;
            font-size: 1.2rem;
            display: flex;
            align-items: center;
            gap: 15px;
        }

        /* === ä¸»å¸ƒå±€å®¹å™¨ === */
        .main-wrapper {
            flex: 1;
            display: flex;
            padding: 10px;
            width: 100%;
        }

        /* === æ£‹ç›˜åŒºåŸŸ === */
        .board-area {
            flex-shrink: 0;
            display: flex;
            justify-content: center;
            align-items: center;
            background: #4a4e69;
            padding: 8px;
            border-radius: 8px;
            box-shadow: 5px 5px 20px rgba(0,0,0,0.4);
        }

        #game-board {
            display: grid;
            grid-template-columns: repeat(15, var(--cell-size));
            grid-template-rows: repeat(15, var(--cell-size));
            gap: 2px;
            background-color: #333;
            border: 2px solid #333;
        }

        .cell {
            width: var(--cell-size);
            height: var(--cell-size);
            background-color: var(--board-bg);
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: calc(var(--cell-size) * 0.28);
            color: #333;
            font-weight: bold;
            position: relative;
            user-select: none;
            cursor: pointer;
        }

        .cell.dl { background-color: var(--dl-color); color: #004d40; }
        .cell.tl { background-color: var(--tl-color); color: white; }
        .cell.dw { background-color: var(--dw-color); color: #880e4f; }
        .cell.tw { background-color: var(--tw-color); color: #880e4f; }
        .cell.center { background-color: var(--dw-color); font-size: calc(var(--cell-size) * 0.6); }

        .tile {
            width: calc(var(--cell-size) - 4px);
            height: calc(var(--cell-size) - 4px);
            background-color: var(--tile-bg);
            border-radius: 4px;
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: calc(var(--cell-size) * 0.55);
            font-weight: bold;
            color: var(--tile-color);
            box-shadow: 2px 2px 4px rgba(0,0,0,0.2);
            cursor: grab;
            z-index: 10;
            position: relative;
            transition: transform 0.1s, border 0.1s, box-shadow 0.1s;
        }
        .tile span.points {
            position: absolute;
            bottom: 2px;
            right: 3px;
            font-size: calc(var(--cell-size) * 0.25);
            color: #666;
        }
        .tile.temp { border: 2px solid #4caf50; box-shadow: 0 0 5px #4caf50; }
        .tile.locked { cursor: default; background-color: #ddd; color: #555; }
        .tile.selected {
            transform: translateY(-8px) scale(1.1);
            border: 2px solid #ffd700;
            box-shadow: 0 0 15px rgba(255, 215, 0, 0.9);
            z-index: 20;
            background-color: #fffbf0;
        }
        .rack-swapping {
            background: rgba(233, 196, 106, 0.2) !important;
            border: 2px dashed #e9c46a !important;
        }

        .sidebar {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        .panel {
            background: rgba(255,255,255,0.07);
            padding: 15px;
            border-radius: 12px;
            backdrop-filter: blur(5px);
            border: 1px solid rgba(255,255,255,0.1);
        }

        #rack-container {
            background: rgba(0,0,0,0.3);
            padding: 15px;
            border-radius: 10px;
            min-height: calc(var(--cell-size) * 1.2 + 20px);
            display: flex;
            gap: 8px;
            justify-content: center;
            align-items: center;
            flex-wrap: wrap;
            border: 2px dashed rgba(255,255,255,0.1);
            transition: background 0.3s;
        }
        
        #rack-container .tile {
            transform: scale(1.1); 
            margin: 5px;
            cursor: pointer;
        }
        #rack-container .tile.selected {
            transform: scale(1.2) translateY(-5px);
        }

        .score-board {
            flex-grow: 1;
            display: flex;
            flex-direction: column;
        }
        .player-score {
            display: flex;
            justify-content: space-between;
            padding: 8px 10px;
            font-size: 1rem;
            border-bottom: 1px solid rgba(255,255,255,0.05);
            border-radius: 4px;
        }
        .player-score.active { 
            background: linear-gradient(90deg, rgba(255,215,0,0.2) 0%, transparent 100%);
            color: #ffd700; 
            font-weight: bold;
            border-left: 4px solid #ffd700;
        }
        .player-score.eliminated {
            opacity: 0.5;
            background: rgba(0,0,0,0.3);
            color: #aaa;
            text-decoration: line-through;
        }

        .actions { 
            display: grid; 
            grid-template-columns: 1fr 1fr 1fr;
            gap: 10px; 
        }
        button {
            padding: 12px 5px;
            border: none;
            border-radius: 8px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.2s;
            font-size: 0.9rem;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.2);
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 5px;
        }
        button:active { transform: translateY(2px); box-shadow: 0 1px 2px rgba(0,0,0,0.2); }
        button:disabled { opacity: 0.5; cursor: not-allowed; filter: grayscale(100%); }
        
        .btn-play { background: #2a9d8f; color: white; grid-column: span 3; font-size: 1.1rem; padding: 15px;}
        .btn-swap { background: #e9c46a; color: #333; }
        .btn-swap.active { background: #ffca3a; box-shadow: inset 0 0 10px rgba(0,0,0,0.2); animation: pulse 2s infinite; }
        .btn-reset { background: #e76f51; color: white; }
        .btn-pass { background: #264653; color: white; }
        .btn-shuffle { background: #457b9d; color: white; grid-column: span 2; font-size: 0.8rem; opacity: 0.9;} 
        .btn-help { background: #607d8b; color: white; grid-column: span 1; font-size: 0.8rem; opacity: 0.9; }

        @keyframes pulse { 0% { transform: scale(1); } 50% { transform: scale(1.02); } 100% { transform: scale(1); } }

        #message-area {
            text-align: center;
            color: #ffd700;
            font-weight: bold;
            padding: 10px;
            background: rgba(0,0,0,0.4);
            border-radius: 6px;
            font-size: 1rem;
        }

        .legend {
            display: flex;
            justify-content: space-around;
            font-size: 0.75rem;
            padding: 10px;
        }
        .legend div { display: flex; align-items: center; gap: 5px; }

        .modal {
            display: none;
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.85);
            justify-content: center;
            align-items: center;
            z-index: 2000; /* æé«˜å±‚çº§ï¼Œç¡®ä¿è¦†ç›–åœ¨æœ€ä¸Šå±‚ */
        }
        .modal-content {
            background: white;
            color: #333;
            padding: 30px;
            border-radius: 15px;
            text-align: center;
            box-shadow: 0 10px 30px rgba(0,0,0,0.5);
            max-width: 600px;
            width: 90%;
            max-height: 85vh;
            overflow-y: auto;
            position: relative;
        }
        .tutorial-section { text-align: left; margin-bottom: 20px; padding: 10px; background: #f9f9f9; border-radius: 8px; }
        .tutorial-section h3 { color: #2a9d8f; border-bottom: 2px solid #eee; padding-bottom: 5px; margin-top: 0;}
        .tutorial-list { padding-left: 20px; margin: 10px 0; }
        .tutorial-list li { margin-bottom: 8px; line-height: 1.4; }
        .key-point { font-weight: bold; color: #e76f51; }
        .close-btn { position: absolute; top: 15px; right: 20px; font-size: 1.5rem; cursor: pointer; color: #999; }
        .endgame-table { width: 100%; border-collapse: collapse; margin: 20px 0; }
        .endgame-table th, .endgame-table td { padding: 10px; border-bottom: 1px solid #ddd; }
        .endgame-table th { background: #f0f0f0; color: #333; }
        .score-change.negative { color: #e76f51; }
        .score-change.positive { color: #2a9d8f; font-weight: bold; }

        /* === èŠå¤©å®¤æ ·å¼ === */
        #chat-container { position: fixed; bottom: 20px; right: 20px; z-index: 3000; display: flex; flex-direction: column; align-items: flex-end; gap: 10px; font-family: 'Segoe UI', sans-serif; }
        #chat-toggle-btn { width: 55px; height: 55px; border-radius: 50%; background: #2a9d8f; color: white; font-size: 26px; box-shadow: 0 4px 15px rgba(0,0,0,0.4); border: none; cursor: pointer; position: relative; transition: transform 0.2s; display: flex; justify-content: center; align-items: center;}
        #chat-toggle-btn:active { transform: scale(0.95); }
        #chat-notification { position: absolute; top: 0; right: 0; width: 16px; height: 16px; background: #e76f51; border-radius: 50%; border: 2px solid #22223b; display: none; }
        #chat-window { width: 320px; height: 450px; background: rgba(34, 34, 59, 0.95); backdrop-filter: blur(10px); border: 1px solid rgba(255,255,255,0.1); border-radius: 15px; display: flex; flex-direction: column; overflow: hidden; box-shadow: 0 10px 30px rgba(0,0,0,0.6); display: none; animation: slideIn 0.3s ease-out; }
        @keyframes slideIn { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
        #chat-header { padding: 12px 15px; background: rgba(0,0,0,0.3); border-bottom: 1px solid rgba(255,255,255,0.1); display: flex; justify-content: space-between; align-items: center; font-weight: bold; color: #ffd700; }
        #chat-header button { background: none; border: none; color: #aaa; font-size: 1.2rem; cursor: pointer; padding: 0; }
        #chat-messages { flex: 1; overflow-y: auto; padding: 15px; display: flex; flex-direction: column; gap: 10px; font-size: 0.95rem; }
        .chat-msg { background: rgba(255,255,255,0.1); padding: 8px 12px; border-radius: 10px; max-width: 85%; word-wrap: break-word; line-height: 1.4; position: relative; }
        .chat-msg.mine { align-self: flex-end; background: #2a9d8f; color: white; border-bottom-right-radius: 2px; }
        .chat-msg.others { align-self: flex-start; background: #4a4e69; color: white; border-bottom-left-radius: 2px; }
        .chat-msg.system { align-self: center; background: rgba(255,215,0,0.15); color: #ffd700; font-size: 0.8rem; font-style: italic; padding: 4px 10px; border-radius: 20px; border: 1px dashed rgba(255,215,0,0.3); }
        .chat-name { font-size: 0.75rem; color: #ccc; margin-bottom: 4px; display: block; font-weight: bold; }
        .chat-msg.mine .chat-name { display: none; }
        #chat-input-wrapper { padding: 12px; border-top: 1px solid rgba(255,255,255,0.1); display: flex; gap: 8px; background: rgba(0,0,0,0.2); }
        #chat-input { flex: 1; padding: 10px; border-radius: 20px; border: 1px solid rgba(255,255,255,0.1); background: rgba(255,255,255,0.08); color: white; outline: none; }
        #chat-input:focus { background: rgba(255,255,255,0.15); border-color: #2a9d8f; }
        #chat-send-btn { padding: 8px 15px; background: #2a9d8f; border: none; border-radius: 20px; color: white; cursor: pointer; font-weight: bold; font-size: 0.9rem; transition: background 0.2s; }
        #chat-send-btn:hover { background: #21867a; }

        @media (orientation: landscape) {
            body {
                height: 100vh; 
                height: 100dvh; 
                overflow: hidden; 
            }

            :root {
                --available-h: calc(100dvh - 100px); 
                --cell-size: min(calc(var(--available-h) / 15), calc(55vw / 15));
                --sidebar-padding: 20px;
            }

            .main-wrapper {
                height: calc(100dvh - 50px);
                overflow: hidden;
                align-items: center;
                justify-content: flex-start;
                gap: 2vw;
                padding: 5px var(--sidebar-padding);
            }

            .board-area { padding: 4px; }
            .sidebar {
                flex: 1;
                height: calc(15 * var(--cell-size) + 12px); 
                min-width: 280px;
                gap: 2vh; 
            }
            .panel { padding: 1.5vh; }
            .panel, button, .player-score { font-size: clamp(0.8rem, 2.2vh, 1rem); }
            h4 { margin: 0 0 0.5vh 0; }
            #rack-container {
                min-height: calc(var(--cell-size) * 1.2 + 10px);
                padding: 5px;
            }
            button { padding: 1.2vh 5px; }
            .score-board { overflow-y: auto; flex-shrink: 1; }
        }

        @media (orientation: portrait) {
            :root { --cell-size: calc((100vw - 20px) / 15); }
            .main-wrapper {
                flex-direction: column;
                justify-content: flex-start;
                padding: 10px;
                height: auto; 
                overflow: visible;
            }
            .sidebar { width: 100%; height: auto; flex: none; gap: 10px; }
            .board-area { margin-bottom: 10px; }
            .score-board { display: none; } 
            .mobile-score { display: inline-block !important; color: #ffd700; font-size: 0.9rem;}
            #rack-container .tile { transform: scale(1); }
            #rack-container .tile.selected { transform: scale(1.1) translateY(-5px); }
            
            /* ç§»åŠ¨ç«¯è°ƒæ•´èŠå¤©çª—ä½ç½® */
            #chat-window { width: 85vw; height: 50vh; bottom: 80px; right: 20px; }
        }
        
        .mobile-score { display: none; }
        
        /* Online Lobby Styles */
        #lobby-overlay {
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            background: #1a1a2e;
            z-index: 200;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            color: white;
        }
        .lobby-box {
            background: #22223b;
            padding: 30px;
            border-radius: 15px;
            text-align: center;
            box-shadow: 0 10px 30px rgba(0,0,0,0.5);
            border: 1px solid #4a4e69;
            width: 90%;
            max-width: 400px;
            position: relative;
        }
        .lobby-input {
            padding: 12px;
            border-radius: 5px;
            border: none;
            margin: 10px auto;
            width: 80%;
            display: block;
            font-size: 1.1rem;
            text-align: center;
            letter-spacing: 1px;
        }
        .lobby-btn {
            background: #2a9d8f;
            color: white;
            padding: 12px 20px;
            border: none;
            border-radius: 5px;
            font-size: 1rem;
            cursor: pointer;
            margin: 15px auto;
            width: 80%;
            display: block;
        }
        .lobby-btn.secondary { background: #4a4e69; }
        
        /* Waiting Room Styles */
        #waiting-area {
            display: none;
            margin-top: 20px;
            border-top: 1px solid rgba(255,255,255,0.1);
            padding-top: 20px;
        }
        .player-list-item {
            background: rgba(255,255,255,0.1);
            margin: 5px 0;
            padding: 10px;
            border-radius: 5px;
            display: flex;
            justify-content: space-between;
        }
        .waiting-title { color: #ffd700; font-size: 0.9rem; margin-bottom: 10px; }
    </style>
</head>
<body>

    <header>
        <h1>G-MATH ğŸ§® <span class="mobile-score" id="mobile-score-display"></span></h1>
        <div style="font-size: 0.9rem; color: #ccc;">
            å‰©ä½™: <span id="tiles-left-header" style="font-weight:bold; color:white;">0</span>
        </div>
    </header>

    <div class="main-wrapper">
        <div class="board-area">
            <div id="game-board"></div>
        </div>

        <div class="sidebar">
            <div id="message-area">æ¬¢è¿æ¥åˆ° G-MATH!</div>

            <div class="panel score-board">
                <h4 style="border-bottom:1px solid rgba(255,255,255,0.2); padding-bottom:5px;">
                    ğŸ“Š ç©å®¶ç§¯åˆ†
                </h4>
                <div id="players-list"></div>
            </div>

            <div class="panel">
                <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:5px;">
                    <div style="font-weight:bold; color:#ddd;">ğŸ–ï¸ ä½ çš„æ‰‹ç‰Œ:</div>
                    <div style="font-size:0.8em; color:#aaa;" id="rack-hint">(ç‚¹å‡»é€‰ä¸­ï¼Œå†ç‚¹æ£‹ç›˜)</div>
                </div>
                <div id="rack-container"></div>
            </div>

            <div class="actions">
                <button class="btn-play" id="btn-play" onclick="game.playTurn()">âœ… ç¡®è®¤å‡ºç‰Œ</button>
                
                <button class="btn-swap" id="btn-swap" onclick="game.toggleSwapMode()">â™»ï¸ æ¢ç‰Œ</button>
                <button class="btn-reset" id="btn-reset" onclick="game.recallTiles()">â†©ï¸ æ”¶å›</button>
                <button class="btn-pass" id="btn-pass" onclick="game.passTurn()">â­ï¸ è·³è¿‡</button>
                
                <button class="btn-shuffle" onclick="game.shuffleRack()">ğŸ”€ æ•´ç†</button>
                <button class="btn-help" onclick="game.showTutorial()">â“ è¯´æ˜</button>
            </div>
            
            <div class="panel legend">
                <div><span style="color:var(--dl-color)">â– </span> 2å€æ•°</div>
                <div><span style="color:var(--tl-color)">â– </span> 3å€æ•°</div>
                <div><span style="color:var(--dw-color)">â– </span> 2å€å¼</div>
                <div><span style="color:var(--tw-color)">â– </span> 3å€å¼</div>
            </div>
        </div>
    </div>

    <!-- Chat UI -->
    <div id="chat-container" style="display:none;">
        <div id="chat-window">
            <div id="chat-header">
                <span>ğŸ’¬ èŠå¤©å®¤</span>
                <button onclick="window.toggleChat()">Ã—</button>
            </div>
            <div id="chat-messages"></div>
            <div id="chat-input-wrapper">
                <input type="text" id="chat-input" placeholder="è¾“å…¥æ¶ˆæ¯..." maxlength="50">
                <button id="chat-send-btn" onclick="window.sendChatMessage()">å‘é€</button>
            </div>
        </div>
        <button id="chat-toggle-btn" onclick="window.toggleChat()">
            ğŸ’¬
            <div id="chat-notification"></div>
        </button>
    </div>

    <!-- Modal: Game Over -->
    <div id="modal" class="modal">
        <div class="modal-content" style="max-width: 500px;">
            <h2 id="modal-title" style="margin-top:0">ğŸ† æ¸¸æˆç»“æŸ</h2>
            <div id="modal-msg"></div>
            <button onclick="location.reload()" style="background:#2a9d8f; color:white; padding:15px 30px; font-size:1.1rem; margin-top: 20px;">å†ç©ä¸€æ¬¡</button>
        </div>
    </div>

    <!-- Modal: Tutorial -->
    <div id="tutorial-modal" class="modal" style="display: none;">
        <div class="modal-content" style="text-align:left; max-width: 650px;">
            <span class="close-btn" onclick="document.getElementById('tutorial-modal').style.display='none'">&times;</span>
            <h2 style="text-align:center; margin-top:0; color:#4a4e69;">ğŸ“– G-MATH æ¸¸æˆæŒ‡å—</h2>
            
            <div class="tutorial-section">
                <h3>ğŸ¯ æ¸¸æˆç›®æ ‡</h3>
                <p>åˆ©ç”¨æ‰‹ä¸­çš„æ•°å­—å’Œç¬¦å·ç‰Œï¼Œåœ¨æ£‹ç›˜ä¸Šæ‹¼å‡º<strong>æ­£ç¡®çš„æ•°å­¦ç­‰å¼</strong>ï¼Œäº‰å–è·å¾—æœ€é«˜åˆ†ï¼</p>
            </div>

            <div class="tutorial-section">
                <h3>ğŸ•¹ï¸ ç©æ³•æµç¨‹</h3>
                <ul class="tutorial-list">
                    <li><strong>æ‰‹ç‰Œé…ç½®ï¼š</strong>ä½ ä¼šä¸€ç›´æ‹¥æœ‰ <span style="color:#2a9d8f; font-weight:bold;">5å¼ æ•°å­—</span> å’Œ <span style="color:#e76f51; font-weight:bold;">3å¼ ç¬¦å·</span>ï¼Œè¯·åˆç†è§„åˆ’ä½¿ç”¨ã€‚</li>
                    <li><strong>ç¬¬ä¸€æ­¥ï¼š</strong>é¦–ä½ç©å®¶å‡ºç‰Œå¿…é¡»è¦†ç›–æ£‹ç›˜ä¸­å¿ƒçš„ <span style="color:#ffaaa5; font-weight:bold;">â˜…</span> æ˜Ÿå·ã€‚</li>
                    <li><strong>è¿æ¥ï¼š</strong>ä¹‹åçš„å‡ºç‰Œå¿…é¡»æ¨ªå‘æˆ–çºµå‘æ’åˆ—ï¼Œå¹¶ä¸æ£‹ç›˜ä¸Šå·²æœ‰çš„ç‰Œç›¸è¿ã€‚</li>
                    <li><strong>ç­‰å¼ï¼š</strong>å¿…é¡»å½¢æˆæ•°å­¦ä¸Šæˆç«‹çš„ç­‰å¼ï¼ˆåŒ…å« <code>=</code>ï¼‰ã€‚<br>
                        <small style="color:#555; background:#eee; padding:2px 5px; border-radius:4px;">âœ” ä¾‹å­ï¼š<code>2+3=5</code> æˆ–è¿ç­‰å¼ <code>32Ã·8=7-3=4</code></small>
                    </li>
                </ul>
            </div>

            <div class="tutorial-section">
                <h3>ğŸ–ï¸ æ“ä½œæŒ‡å— (æ”¯æŒè§¦å±)</h3>
                <ul class="tutorial-list">
                    <li><strong>å‡ºç‰Œï¼š</strong>ç‚¹å‡»æ‰‹ç‰Œé€‰ä¸­ï¼ˆå˜äº®ï¼‰ -> ç‚¹å‡»æ£‹ç›˜æ ¼å­æ”¾ç½®ã€‚</li>
                    <li><strong>è°ƒæ•´ï¼š</strong>ç‚¹å‡»æ£‹ç›˜ä¸Šåˆšæ”¾ä¸‹çš„ç‰Œï¼Œå¯ä»¥å°†å…¶æ”¶å›æ‰‹ç‰Œã€‚</li>
                    <li><strong>æ¢ç‰Œï¼š</strong>æ‰‹ç‰Œä¸å¥½ï¼Ÿç‚¹å‡»â€œâ™»ï¸ æ¢ç‰Œâ€è¿›å…¥æ¢ç‰Œæ¨¡å¼ã€‚<br>
                        <span style="color:#e76f51; font-size:0.9em;">(æ³¨æ„ï¼šæ¢ç‰Œè§†ä¸ºæœªå¾—åˆ†æ“ä½œï¼Œä¼šè·³è¿‡æœ¬å›åˆ)</span>
                    </li>
                </ul>
            </div>

            <div class="tutorial-section">
                <h3>ğŸ† ç«æŠ€è§„åˆ™</h3>
                <ul class="tutorial-list">
                    <li><strong>æ·˜æ±°æœºåˆ¶ï¼š</strong>åŒä¸€ç©å®¶è¿ç»­ <span class="key-point">3æ¬¡</span> æœªå¾—åˆ†ï¼ˆè·³è¿‡æˆ–æ¢ç‰Œï¼‰ï¼Œå°†è¢«<span class="key-point">ç›´æ¥æ·˜æ±°</span>å‡ºå±€ï¼</li>
                    <li><strong>æ¸¸æˆç»“æŸï¼š</strong>å½“ç‰Œåº“ç©ºäº†ä¸”æœ‰äººå‡ºå®Œç‰Œï¼Œæˆ–è€…åœºä¸Šåªå‰©1äººæ—¶ç»“æŸã€‚</li>
                    <li><strong>èƒœè´Ÿï¼š</strong>æœ€ç»ˆç§¯åˆ†æœ€é«˜è€…è·èƒœã€‚</li>
                </ul>
            </div>

            <div style="background:#e3f2fd; padding:12px; border-radius:8px; margin-top:15px; text-align:center; border:1px solid #bbdefb; color:#0d47a1;">
                ğŸ–¥ï¸ <strong>ä½“éªŒå‡çº§ï¼š</strong> å»ºè®®æŒ‰é”®ç›˜ <strong>F11</strong> è¿›å…¥å…¨å±æ¨¡å¼ï¼Œæ“ä½œæ›´é¡ºç•…ï¼
            </div>

            <div style="text-align:center; margin-top:20px;">
                <button onclick="document.getElementById('tutorial-modal').style.display='none'" style="background:#2a9d8f; color:white; padding:12px 40px; font-size:1.1rem; border:none; border-radius:8px; cursor:pointer; font-weight:bold; box-shadow: 0 4px 6px rgba(0,0,0,0.2);">å¼€å§‹æŒ‘æˆ˜ï¼</button>
            </div>
        </div>
    </div>

<!-- Online Lobby Overlay -->
<div id="lobby-overlay">
    <div class="lobby-box">
        <h2>G-MATH è”æœºå¤§å…</h2>
        
        <!-- åˆå§‹é€‰æ‹©ç•Œé¢ -->
        <div id="lobby-initial">
            <input type="text" id="nickname-input" class="lobby-input" placeholder="è¯·è¾“å…¥æ‚¨çš„æ˜µç§°" maxlength="8">
            <div style="margin-top:20px;">
                <button class="lobby-btn" onclick="createRoom()">åˆ›å»ºæˆ¿é—´</button>
                <p style="margin:10px; color:#aaa;">- æˆ– -</p>
                <input type="number" id="room-input" class="lobby-input" placeholder="è¾“å…¥6ä½æˆ¿é—´å·">
                <button class="lobby-btn secondary" onclick="joinRoom()">åŠ å…¥æˆ¿é—´</button>
            </div>
        </div>

        <!-- ç­‰å¾…å¤§å…ç•Œé¢ -->
        <div id="waiting-area">
            <h3>æˆ¿é—´å·: <span id="display-room-id" style="color:#2a9d8f; letter-spacing:2px;"></span></h3>
            <div class="waiting-title">å·²åŠ å…¥ç©å®¶ (<span id="player-count">0</span>/4):</div>
            <div id="waiting-list" style="text-align:left; margin-bottom:20px;"></div>
            <div id="host-controls" style="display:none;">
                <button class="lobby-btn" onclick="startGameAsHost()">å¼€å§‹æ¸¸æˆ</button>
            </div>
            <div id="guest-msg" style="display:none; color:#aaa; font-style:italic;">
                ç­‰å¾…æˆ¿ä¸»å¼€å§‹æ¸¸æˆ...
            </div>
        </div>

        <div id="lobby-status" style="margin-top:20px; color:#ffd700; min-height: 20px; font-size: 0.9rem;"></div>
    </div>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.13.1/firebase-app.js";
import { getAnalytics } from "https://www.gstatic.com/firebasejs/10.13.1/firebase-analytics.js";
import { getFirestore, doc, setDoc, getDoc, onSnapshot, updateDoc, arrayUnion } from "https://www.gstatic.com/firebasejs/10.13.1/firebase-firestore.js";
import { getAuth, signInAnonymously } from "https://www.gstatic.com/firebasejs/10.13.1/firebase-auth.js";

const firebaseConfig = {
    apiKey: "AIzaSyDG8QBOaVkG2X2q04dyG0wVe-vYvsOVAdQ",
    authDomain: "g-math-pvp-35665.firebaseapp.com",
    projectId: "g-math-pvp-35665",
    storageBucket: "g-math-pvp-35665.firebasestorage.app",
    messagingSenderId: "715488897072",
    appId: "1:715488897072:web:88c73bf50912fd6c90e5f5",
    measurementId: "G-63SZM7FYCZ"
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);
const auth = getAuth(app);

let currentRoomId = null;
let myPlayerId = null;
let myNickname = "";
let isHost = false;
let hasShownTutorial = false; // æ ‡è®°æ˜¯å¦å·²è‡ªåŠ¨å¼¹çª—

// --- èŠå¤©å®¤å˜é‡ ---
let isChatOpen = false;
let lastChatCount = 0;
let audioContext = null;

// --- æ¸¸æˆé€»è¾‘é…ç½® ---
const BOARD_SIZE = 15;
const RACK_SIZE = 8; 
const TILE_DISTRIBUTION = {
    '0': { count: 6, score: 1 }, '1': { count: 6, score: 1 }, '2': { count: 6, score: 2 },
    '3': { count: 6, score: 2 }, '4': { count: 6, score: 2 }, '5': { count: 6, score: 3 },
    '6': { count: 6, score: 3 }, '7': { count: 6, score: 4 }, '8': { count: 6, score: 4 },
    '9': { count: 6, score: 4 }, '+': { count: 7, score: 2 }, '-': { count: 7, score: 2 },
    'Ã—': { count: 7, score: 4 }, 'Ã·': { count: 7, score: 4 }, '=': { count: 20, score: 1 }
};
const SPECIAL_CELLS = {
    'TW': ['0,0', '0,7', '0,14', '7,0', '7,14', '14,0', '14,7', '14,14'],
    'DW': ['1,1', '2,2', '3,3', '4,4', '10,10', '11,11', '12,12', '13,13', '1,13', '2,12', '3,11', '4,10', '10,4', '11,3', '12,2', '13,1'],
    'TL': ['1,5', '1,9', '5,1', '5,5', '5,9', '5,13', '9,1', '9,5', '9,9', '9,13', '13,5', '13,9'],
    'DL': ['0,3', '0,11', '2,6', '2,8', '3,0', '3,7', '3,14', '6,2', '6,6', '6,8', '6,12', '7,3', '7,11', '8,2', '8,6', '8,8', '8,12', '11,0', '11,7', '11,14', '12,6', '12,8', '14,3', '14,11']
};

class Tile {
    constructor(char, id) {
        this.char = char;
        this.score = TILE_DISTRIBUTION[char].score;
        this.id = id; 
        this.element = this.createElement();
    }
    createElement() {
        const el = document.createElement('div');
        el.className = 'tile';
        el.draggable = true;
        el.id = `tile-${this.id}`;
        el.dataset.tileId = this.id;
        el.innerHTML = `${this.char}<span class="points">${this.score}</span>`;
        el.addEventListener('dragstart', (e) => {
            e.dataTransfer.setData('text/plain', this.id);
            e.dataTransfer.effectAllowed = "move";
            game.draggedTileId = this.id;
            game.selectTile(this.id, true); 
        });
        return el;
    }
}

class Game {
    constructor() {
        this.players = []; // åˆå§‹ä¸ºç©ºï¼Œç­‰å¾…è”æœºæ•°æ®
        this.currentPlayerIndex = 0;
        this.numberBag = [];
        this.operatorBag = []; 
        this.boardState = Array(BOARD_SIZE).fill(null).map(() => Array(BOARD_SIZE).fill(null)); 
        this.isFirstTurn = true;
        this.tempPlacedTiles = []; 
        this.selectedTileIds = new Set(); 
        this.isSwapping = false; 
        this.draggedTileId = null;
        this.consecutivePasses = 0;
    }

    // ä¿®å¤ï¼šåŠ å›è¯´æ˜å¼¹çª—æ–¹æ³•
    showTutorial() {
        document.getElementById('tutorial-modal').style.display = 'flex';
    }

    // ä»…ç”¨äºæœ¬åœ°æ¼”ç¤ºæˆ–åˆå§‹åŒ–ç©ºçŠ¶æ€
    initLocal() {
        this.setupPlayers(['æœ¬åœ°ç©å®¶']);
        this.initGameData();
    }

    setupPlayers(names) {
        this.players = names.map(name => ({
            name: name, score: 0, rack: [], misses: 0, active: true
        }));
    }

    initGameData() {
        this.generateTileBag();
        this.renderBoard();
        this.shuffleBag();
        this.players.forEach(p => this.drawTiles(p));
        this.updateUI();
    }

    generateTileBag() {
        this.numberBag = [];
        this.operatorBag = [];
        let idCounter = 0;
        for (let char in TILE_DISTRIBUTION) {
            const count = TILE_DISTRIBUTION[char].count;
            const isNumber = /^[0-9]$/.test(char);
            for (let i = 0; i < count; i++) {
                const tile = new Tile(char, idCounter++);
                if (isNumber) this.numberBag.push(tile);
                else this.operatorBag.push(tile);
            }
        }
    }

    shuffleBag() {
        const shuffle = (arr) => {
            for (let i = arr.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [arr[i], arr[j]] = [arr[j], arr[i]];
            }
        };
        shuffle(this.numberBag);
        shuffle(this.operatorBag);
    }

    drawTiles(player) {
        let currentNums = player.rack.filter(t => /^[0-9]$/.test(t.char)).length;
        let currentOps = player.rack.filter(t => !/^[0-9]$/.test(t.char)).length;
        const MAX_NUMS = 5;
        const MAX_OPS = 3;
        let shortageMsg = "";

        while (currentNums < MAX_NUMS && this.numberBag.length > 0) {
            player.rack.push(this.numberBag.pop());
            currentNums++;
        }
        while (currentOps < MAX_OPS && this.operatorBag.length > 0) {
            player.rack.push(this.operatorBag.pop());
            currentOps++;
        }
        
        if (currentNums < MAX_NUMS && this.numberBag.length === 0) shortageMsg = "æ•°å­—ç‰Œè€—å°½";
        if (currentOps < MAX_OPS && this.operatorBag.length === 0) {
            shortageMsg = shortageMsg ? "ç‰Œåº“è€—å°½" : "è¿ç®—ç‰Œè€—å°½";
        }
        return shortageMsg;
    }

    // å…³é”®ä¿®å¤ï¼šé‡æ–°æ¸²æŸ“æ£‹ç›˜æ—¶ï¼Œæ£€æŸ¥å¹¶æ˜¾ç¤ºå·²æœ‰çš„æ£‹å­
    renderBoard() {
        const boardEl = document.getElementById('game-board');
        boardEl.innerHTML = '';
        for (let r = 0; r < BOARD_SIZE; r++) {
            for (let c = 0; c < BOARD_SIZE; c++) {
                const cell = document.createElement('div');
                cell.className = 'cell';
                cell.dataset.r = r;
                cell.dataset.c = c;

                const key = `${r},${c}`;

                // æ£€æŸ¥è¯¥ä½ç½®æ˜¯å¦æœ‰ç‰Œ
                const tile = this.boardState[r][c];
                if (tile) {
                    const tileEl = tile.element;
                    // ç¡®ä¿å·²é”å®šçš„ç‰Œæ²¡æœ‰äº¤äº’æ ·å¼
                    tileEl.classList.remove('temp', 'selected');
                    tileEl.classList.add('locked');
                    tileEl.draggable = false;
                    tileEl.onclick = null; 
                    cell.appendChild(tileEl);
                } else {
                    // å¦‚æœæ²¡æœ‰ç‰Œï¼Œæ˜¾ç¤ºèƒŒæ™¯æ–‡å­—
                    if (r===7 && c===7) { cell.classList.add('center'); cell.innerHTML='â˜…'; }
                    else if (SPECIAL_CELLS.TW.includes(key)) { cell.classList.add('tw'); cell.innerText='TW'; }
                    else if (SPECIAL_CELLS.DW.includes(key)) { cell.classList.add('dw'); cell.innerText='DW'; }
                    else if (SPECIAL_CELLS.TL.includes(key)) { cell.classList.add('tl'); cell.innerText='TL'; }
                    else if (SPECIAL_CELLS.DL.includes(key)) { cell.classList.add('dl'); cell.innerText='DL'; }
                }

                cell.onclick = () => this.handleBoardClick(r, c);
                cell.addEventListener('dragover', (e) => e.preventDefault());
                cell.addEventListener('drop', (e) => this.handleDropOnBoard(e, r, c));
                boardEl.appendChild(cell);
            }
        }
    }

    renderRack() {
        const rackContainer = document.getElementById('rack-container');
        rackContainer.innerHTML = '';
        // åªæœ‰å½“å‰ç©å®¶æ˜¯è‡ªå·±æ—¶æ‰æ¸²æŸ“å¯æ“ä½œçš„æ‰‹ç‰Œï¼Œå¦åˆ™æ˜¾ç¤ºä¸å¯æ“ä½œæˆ–ä¸ºç©º
        const isMyTurn = this.currentPlayerIndex < this.players.length && 
                         (myPlayerId === null || this.players[this.currentPlayerIndex].name === myNickname);
        
        // åœ¨è”æœºæ¨¡å¼ä¸‹ï¼Œæˆ‘ä»¬åªæ˜¾ç¤ºè‡ªå·±çš„æ‰‹ç‰Œï¼Œæ— è®ºæ˜¯ä¸æ˜¯è‡ªå·±çš„å›åˆ
        let myPlayer = null;
        if (myNickname) {
            myPlayer = this.players.find(p => p.name === myNickname);
        } else {
            // æœ¬åœ°æµ‹è¯•å…œåº•
            myPlayer = this.players[this.currentPlayerIndex];
        }

        if (!myPlayer) return;

        if (this.isSwapping) rackContainer.classList.add('rack-swapping');
        else rackContainer.classList.remove('rack-swapping');

        myPlayer.rack.forEach(tile => {
            const tileEl = tile.element;
            tileEl.classList.remove('temp', 'locked');
            if (this.selectedTileIds.has(tile.id)) tileEl.classList.add('selected');
            else tileEl.classList.remove('selected');

            tileEl.onclick = (e) => {
                e.stopPropagation();
                this.handleRackTileClick(tile.id);
            };
            rackContainer.appendChild(tileEl);
        });
    }

    handleRackTileClick(tileId) {
        if (this.isSwapping) {
            if (this.selectedTileIds.has(tileId)) this.selectedTileIds.delete(tileId);
            else this.selectedTileIds.add(tileId);
        } else {
            if (this.selectedTileIds.has(tileId)) {
                this.selectedTileIds.clear();
            } else {
                this.selectedTileIds.clear();
                this.selectedTileIds.add(tileId);
            }
        }
        this.renderRack();
    }

    handleBoardClick(r, c) {
        if (this.boardState[r][c] && !this.isTemp(r, c)) return;
        if (this.isTemp(r, c)) {
            const tile = this.boardState[r][c];
            this.boardState[r][c] = null;
            const tempIdx = this.tempPlacedTiles.findIndex(t => t.r === r && t.c === c);
            if (tempIdx > -1) this.tempPlacedTiles.splice(tempIdx, 1);
            this.updateCellUI(r, c);
            
            // æ‰¾åˆ°å½“å‰æ“ä½œç©å®¶
            const player = this.players.find(p => p.name === myNickname) || this.players[this.currentPlayerIndex];
            player.rack.push(tile);
            
            this.selectedTileIds.clear();
            this.selectedTileIds.add(tile.id);
            this.renderRack();
            this.showMessage("å·²æ”¶å›ç‰Œï¼Œç‚¹å‡»ç©ºæ ¼æ”¾ç½®");
            return;
        }
        if (this.selectedTileIds.size === 1 && !this.isSwapping) {
            const tileId = Array.from(this.selectedTileIds)[0];
            // æ‰¾åˆ°å½“å‰æ“ä½œç©å®¶
            const player = this.players.find(p => p.name === myNickname) || this.players[this.currentPlayerIndex];
            const tileIndex = player.rack.findIndex(t => t.id == tileId);
            if (tileIndex > -1) {
                const tile = player.rack[tileIndex];
                this.placeTileTemp(tile, r, c);
                player.rack.splice(tileIndex, 1);
                this.selectedTileIds.clear();
                this.renderRack();
            }
        }
    }

    selectTile(tileId, forceExclusive = true) {
        if (forceExclusive) this.selectedTileIds.clear();
        this.selectedTileIds.add(tileId);
        this.renderRack();
    }

    handleDropOnBoard(e, r, c) {
        e.preventDefault();
        if (this.boardState[r][c] !== null) return; 
        const player = this.players.find(p => p.name === myNickname) || this.players[this.currentPlayerIndex];
        const tileIndex = player.rack.findIndex(t => t.id == this.draggedTileId);
        if (tileIndex > -1) {
            const tile = player.rack[tileIndex];
            this.placeTileTemp(tile, r, c);
            player.rack.splice(tileIndex, 1);
        } else {
            const existingTempIndex = this.tempPlacedTiles.findIndex(t => t.tile.id == this.draggedTileId);
            if (existingTempIndex > -1) {
                const oldPos = this.tempPlacedTiles[existingTempIndex];
                this.boardState[oldPos.r][oldPos.c] = null;
                this.updateCellUI(oldPos.r, oldPos.c);
                this.tempPlacedTiles.splice(existingTempIndex, 1);
                this.placeTileTemp(oldPos.tile, r, c);
            }
        }
        this.selectedTileIds.clear();
        this.renderRack();
    }

    placeTileTemp(tile, r, c) {
        this.boardState[r][c] = tile;
        this.tempPlacedTiles.push({r, c, tile});
        this.updateCellUI(r, c, true);
    }

    updateCellUI(r, c, isTemp = false) {
        const index = r * BOARD_SIZE + c;
        const cell = document.getElementById('game-board').children[index];
        const tile = this.boardState[r][c];
        if (!tile) {
            cell.innerHTML = '';
            const key = `${r},${c}`;
            if (r===7&&c===7) cell.innerHTML='â˜…';
            else if (SPECIAL_CELLS.TW.includes(key)) cell.innerText='TW';
            else if (SPECIAL_CELLS.DW.includes(key)) cell.innerText='DW';
            else if (SPECIAL_CELLS.TL.includes(key)) cell.innerText='TL';
            else if (SPECIAL_CELLS.DL.includes(key)) cell.innerText='DL';
            return;
        }
        cell.innerHTML = ''; 
        const tileEl = tile.element;
        tileEl.classList.remove('selected');
        tileEl.onclick = null;
        if (isTemp) tileEl.classList.add('temp');
        else tileEl.classList.add('locked');
        tileEl.draggable = isTemp; 
        cell.appendChild(tileEl);
    }

    recallTiles() {
        const player = this.players.find(p => p.name === myNickname) || this.players[this.currentPlayerIndex];
        this.tempPlacedTiles.forEach(item => {
            this.boardState[item.r][item.c] = null;
            this.updateCellUI(item.r, item.c);
            player.rack.push(item.tile);
        });
        this.tempPlacedTiles = [];
        this.selectedTileIds.clear();
        this.renderRack();
    }

    // å…³é”®ä¿®å¤ï¼šè·³è¿‡é€»è¾‘ä¼˜å…ˆåˆ¤æ–­å…¨å‘˜åƒµå±€
    passTurn() {
        if (this.isSwapping) this.toggleSwapMode(); 
        this.recallTiles();
        const player = this.players[this.currentPlayerIndex];
        
        // å¢åŠ è®¡æ•°
        player.misses++;
        this.consecutivePasses++;

        // 1. æ£€æŸ¥å…¨å‘˜è·³è¿‡ (åƒµå±€)
        // å¦‚æœè¿ç»­è·³è¿‡æ¬¡æ•° >= æ´»è·ƒç©å®¶æ•°ï¼Œè¯´æ˜æ¯ä¸ªäººéƒ½Passäº†ä¸€è½®ï¼Œè§¦å‘æ¸¸æˆç»“æŸ
        const activeCount = this.players.filter(p => p.active).length;
        if (this.consecutivePasses >= activeCount) {
            this.endGame(true); // ä¼ å…¥ true è¡¨ç¤ºå› åƒµå±€å¼ºåˆ¶ç»“æŸ
            return;
        }

        // 2. æ£€æŸ¥ä¸ªäººæ·˜æ±°
        if (this.checkElimination(player)) return;

        this.nextTurn(false); 
    }

    toggleSwapMode() {
        if (this.tempPlacedTiles.length > 0) {
            this.showMessage("âŒ è¯·å…ˆæ”¶å›æ£‹ç›˜ä¸Šçš„ç‰Œ", true);
            return;
        }
        if (!this.isSwapping) {
            this.isSwapping = true;
            this.selectedTileIds.clear();
            document.getElementById('btn-swap').innerText = "âœ… ç¡®è®¤äº¤æ¢";
            document.getElementById('btn-swap').classList.add('active');
            document.getElementById('rack-hint').innerText = "(å¤šé€‰æ¨¡å¼ï¼šè¯·é€‰æ‹©è¦ä¸¢å¼ƒçš„ç‰Œ)";
            this.showMessage("è¯·é€‰æ‹©è¦äº¤æ¢çš„ç‰Œï¼Œå†æ¬¡ç‚¹å‡»æŒ‰é’®ç¡®è®¤");
            this.toggleButtons(false);
        } else {
            this.executeSwap();
        }
        this.renderRack();
    }

    executeSwap() {
        if (this.selectedTileIds.size === 0) {
            this.exitSwapMode();
            this.showMessage("æœªé€‰æ‹©ç‰Œï¼Œå·²å–æ¶ˆæ¢ç‰Œ");
            return;
        }
        if (this.numberBag.length === 0 && this.operatorBag.length === 0) {
            this.exitSwapMode();
            this.showMessage("âŒ ç‰Œåº“ç©ºäº†ï¼Œæ— æ³•æ¢ç‰Œ", true);
            return;
        }
        const player = this.players[this.currentPlayerIndex];
        const newRack = [];
        const tilesToSwap = [];
        player.rack.forEach(tile => {
            if (this.selectedTileIds.has(tile.id)) tilesToSwap.push(tile);
            else newRack.push(tile);
        });
        tilesToSwap.forEach(tile => {
            tile.element.classList.remove('selected');
            if (/^[0-9]$/.test(tile.char)) this.numberBag.push(tile);
            else this.operatorBag.push(tile);
        });
        player.rack = newRack;
        this.shuffleBag();
        this.drawTiles(player);
        const count = tilesToSwap.length;
        this.exitSwapMode();
        this.showMessage(`â™»ï¸ æˆåŠŸäº¤æ¢ ${count} å¼ ç‰Œ`);
        
        player.misses++;
        // å…³é”®ä¿®å¤ï¼šæ¢ç‰Œæ‰“ç ´äº†çº¯è·³è¿‡çš„åƒµå±€ï¼ˆæ‰‹ç‰Œå˜äº†ï¼‰ï¼Œé‡ç½®å…¨å‘˜è·³è¿‡è®¡æ•°
        this.consecutivePasses = 0; 
        
        if (this.checkElimination(player)) return;
        this.nextTurn(true);
    }

    checkElimination(player) {
        if (player.misses >= 3) {
            player.active = false; 
            this.showMessage(`ğŸš« ${player.name} è¿ç»­3æ¬¡æœªå¾—åˆ†ï¼Œå·²é€€å‡ºæ¯”èµ›ï¼`, true);
            const activePlayers = this.players.filter(p => p.active);
            if (activePlayers.length <= 1) {
                setTimeout(() => this.endGame(true), 1500); 
            } else {
                setTimeout(() => this.nextTurn(false), 1500);
            }
            return true; 
        }
        return false; 
    }

    exitSwapMode() {
        this.isSwapping = false;
        this.selectedTileIds.clear();
        document.getElementById('btn-swap').innerText = "â™»ï¸ æ¢ç‰Œ";
        document.getElementById('btn-swap').classList.remove('active');
        document.getElementById('rack-hint').innerText = "(ç‚¹å‡»é€‰ä¸­ï¼Œå†æ¬¡ç‚¹å‡»æ£‹ç›˜æ”¾ç½®)";
        this.toggleButtons(true);
        this.renderRack();
    }

    toggleButtons(enable) {
        const ids = ['btn-play', 'btn-reset', 'btn-pass'];
        ids.forEach(id => {
            document.getElementById(id).disabled = !enable;
        });
    }

    shuffleRack() {
        // åªæ´—è‡ªå·±çš„ç‰Œ
        const player = this.players.find(p => p.name === myNickname) || this.players[this.currentPlayerIndex];
        if (!player) return;
        
        for (let i = player.rack.length - 1; i > 0; i--) {
            const j = Math.floor(Math.random() * (i + 1));
            [player.rack[i], player.rack[j]] = [player.rack[j], player.rack[i]];
        }
        this.renderRack();
    }

    playTurn() {
        if (this.isSwapping) return; 
        if (this.tempPlacedTiles.length === 0) {
            this.showMessage("âš ï¸ è¯·å…ˆåœ¨æ£‹ç›˜ä¸Šæ”¾ç½®ç‰Œ", true);
            return;
        }
        const rows = this.tempPlacedTiles.map(t => t.r);
        const cols = this.tempPlacedTiles.map(t => t.c);
        const isRow = rows.every(r => r === rows[0]);
        const isCol = cols.every(c => c === cols[0]);
        if (!isRow && !isCol) {
            this.showMessage("âš ï¸ å¿…é¡»æ’åœ¨åŒä¸€è¡Œæˆ–åŒä¸€åˆ—", true);
            return;
        }
        this.tempPlacedTiles.sort((a, b) => isRow ? a.c - b.c : a.r - b.r);
        let lineTiles = []; 
        if (isRow) lineTiles = this.getContiguousLine(rows[0], this.tempPlacedTiles[0].c, 'row');
        else lineTiles = this.getContiguousLine(this.tempPlacedTiles[0].r, cols[0], 'col');
        if (this.isFirstTurn) {
            const usesCenter = lineTiles.some(t => t.r === 7 && t.c === 7);
            if (!usesCenter) { this.showMessage("âš ï¸ å¿…é¡»ç»è¿‡ä¸­å¿ƒæ˜Ÿå·(â˜…)", true); return; }
            if (lineTiles.length < 3) { this.showMessage("âš ï¸ ç¬¬ä¸€æ­¥è‡³å°‘éœ€è¦3å¼ ç‰Œ", true); return; }
        } else {
            const isConnected = lineTiles.some(t => !this.tempPlacedTiles.includes(t)); 
            let adjacentContact = false;
            if (!isConnected) {
                for (let t of this.tempPlacedTiles) {
                    if (this.hasNeighbor(t.r, t.c)) { adjacentContact = true; break; }
                }
            }
            if (!isConnected && !adjacentContact) { this.showMessage("âš ï¸ å¿…é¡»ä¸ç°æœ‰ç‰Œç›¸è¿", true); return; }
        }
        if (!this.isValidEquation(lineTiles)) {
            this.showMessage("âŒ æ— æ•ˆç­‰å¼: " + this.tilesToString(lineTiles), true);
            return;
        }
        let totalScore = this.calculateScore(lineTiles, isRow ? 'row' : 'col');
        for (let temp of this.tempPlacedTiles) {
            let crossLine = [];
            if (isRow) crossLine = this.getContiguousLine(temp.r, temp.c, 'col');
            else crossLine = this.getContiguousLine(temp.r, temp.c, 'row');
            if (crossLine.length > 1) {
                if (!this.isValidEquation(crossLine)) {
                    this.showMessage("âŒ å‚ç›´æ–¹å‘ç­‰å¼æ— æ•ˆ", true);
                    return;
                }
                totalScore += this.calculateScore(crossLine, isRow ? 'col' : 'row');
            }
        }
        this.confirmMove(totalScore);
    }

    hasNeighbor(r, c) {
        const dirs = [[0,1], [0,-1], [1,0], [-1,0]];
        for (let d of dirs) {
            const nr = r + d[0], nc = c + d[1];
            if (nr >= 0 && nr < BOARD_SIZE && nc >= 0 && nc < BOARD_SIZE) {
                if (this.boardState[nr][nc] && !this.isTemp(nr, nc)) return true;
            }
        }
        return false;
    }

    isTemp(r, c) { return this.tempPlacedTiles.some(t => t.r === r && t.c === c); }

    getContiguousLine(startR, startC, dir) {
        let line = [];
        let currR = startR, currC = startC;
        if (dir === 'row') {
            while (currC > 0 && this.boardState[currR][currC-1]) currC--;
            while (currC < BOARD_SIZE && this.boardState[currR][currC]) {
                line.push({r: currR, c: currC, tile: this.boardState[currR][currC]});
                currC++;
            }
        } else {
            while (currR > 0 && this.boardState[currR-1][currC]) currR--;
            while (currR < BOARD_SIZE && this.boardState[currR][currC]) {
                line.push({r: currR, c: currC, tile: this.boardState[currR][currC]});
                currR++;
            }
        }
        return line;
    }

    isValidEquation(lineObjects) {
        const str = this.tilesToString(lineObjects);
        if (!str.includes('=')) return false;
        const parts = str.split('=');
        if (parts.some(p => p === '')) return false;
        let targetValue = null;
        try {
            const firstPart = parts[0].replace(/Ã—/g, '*').replace(/Ã·/g, '/');
            if (/[^0-9+\-Ã—Ã·]/.test(parts[0])) return false; 
            if (/\/0/.test(firstPart)) return false; 
            targetValue = new Function(`return ${firstPart}`)();
            for (let i = 1; i < parts.length; i++) {
                const currentPartStr = parts[i].replace(/Ã—/g, '*').replace(/Ã·/g, '/');
                if (/[^0-9+\-Ã—Ã·]/.test(parts[i])) return false;
                if (/\/0/.test(currentPartStr)) return false;
                const currentValue = new Function(`return ${currentPartStr}`)();
                if (Math.abs(currentValue - targetValue) > 0.0001) return false; 
            }
            return true;
        } catch (e) { return false; }
    }

    tilesToString(lineObjects) { return lineObjects.map(obj => obj.tile.char).join(''); }

    calculateScore(lineObjects, dir) {
        let score = 0;
        let wordMultiplier = 1;
        lineObjects.forEach(obj => {
            let tileScore = obj.tile.score;
            if (this.isTemp(obj.r, obj.c)) {
                const key = `${obj.r},${obj.c}`;
                if (SPECIAL_CELLS.DL.includes(key)) tileScore *= 2;
                if (SPECIAL_CELLS.TL.includes(key)) tileScore *= 3;
                if (SPECIAL_CELLS.DW.includes(key) || (obj.r===7 && obj.c===7 && this.isFirstTurn)) wordMultiplier *= 2;
                if (SPECIAL_CELLS.TW.includes(key)) wordMultiplier *= 3;
            }
            score += tileScore;
        });
        return score * wordMultiplier;
    }

    confirmMove(points) {
        const player = this.players[this.currentPlayerIndex];
        player.score += points;
        player.misses = 0;
        
        // å…³é”®ä¿®å¤ï¼šæœ‰äººå¾—åˆ†äº†ï¼Œè¯´æ˜æ¸¸æˆè¿˜èƒ½è¿›è¡Œï¼Œé‡ç½®å…¨å‘˜è·³è¿‡è®¡æ•°
        this.consecutivePasses = 0; 
        
        this.showMessage(`ğŸ‰ æœ‰æ•ˆï¼å¾—åˆ†: ${points}`);
        this.tempPlacedTiles.forEach(t => {
            const el = t.tile.element;
            el.classList.remove('temp');
            el.classList.add('locked');
            el.draggable = false;
            this.updateCellUI(t.r, t.c);
        });
        this.tempPlacedTiles = [];
        this.isFirstTurn = false;
        this.selectedTileIds.clear();
        this.nextTurn(true);
    }

    nextTurn(isValidMove = false) {
        const player = this.players[this.currentPlayerIndex];
        let warning = "";
        if (player.active) {
            warning = this.drawTiles(player);
        }
        
        // æ£€æŸ¥æ˜¯å¦ç»“æŸ
        const bagsEmpty = this.numberBag.length === 0 && this.operatorBag.length === 0;
        if (player.rack.length === 0 && bagsEmpty) {
            this.endGame(false, player);
            return;
        }

        // è½®æ¢åˆ°ä¸‹ä¸€ä¸ªæ´»è·ƒç©å®¶
        let loops = 0;
        do {
            this.currentPlayerIndex = (this.currentPlayerIndex + 1) % this.players.length;
            loops++;
        } while (!this.players[this.currentPlayerIndex].active && loops < this.players.length);

        if (loops >= this.players.length) {
            this.endGame(true);
            return;
        }
        
        this.updateUI();
        // æ¶ˆæ¯æç¤ºç”± syncGameState ç»Ÿä¸€å¤„ç†
    }

    endGame(isForced = false, finishingPlayer = null) {
        let msgHTML = "";
        if (isForced) {
            msgHTML += `<div style="color:#e76f51; margin-bottom:10px;">ğŸš« æ¯”èµ›ç»“æŸï¼</div>`;
        } else if (finishingPlayer) {
            msgHTML += `<div style="color:#2a9d8f; margin-bottom:10px;">ğŸ‰ ${finishingPlayer.name} å‡ºå®Œäº†æ‰€æœ‰ç‰Œï¼</div>`;
        }
        // æ‹·è´æ’åºï¼Œä¸å½±å“åŸæ•°ç»„é¡ºåº
        const sortedPlayers = [...this.players].sort((a, b) => b.score - a.score);
        
        let tableHTML = `<table class="endgame-table">
            <tr><th>åæ¬¡</th><th>ç©å®¶</th><th>çŠ¶æ€</th><th>æœ€ç»ˆå¾—åˆ†</th></tr>`;
        sortedPlayers.forEach((p, index) => {
            const status = p.active ? 'å®Œèµ›' : 'æ·˜æ±°';
            const medal = index === 0 ? 'ğŸ¥‡' : (index === 1 ? 'ğŸ¥ˆ' : (index === 2 ? 'ğŸ¥‰' : ''));
            tableHTML += `<tr>
                <td>${medal} ${index + 1}</td>
                <td>${p.name}</td>
                <td style="color:${p.active ? '#2a9d8f' : '#e76f51'}">${status}</td>
                <td><strong>${p.score}</strong></td>
            </tr>`;
        });
        tableHTML += `</table>`;
        document.getElementById('modal-title').innerText = "ğŸ† æœ€ç»ˆæˆ˜æŠ¥";
        document.getElementById('modal-msg').innerHTML = msgHTML + tableHTML;
        document.getElementById('modal').style.display = 'flex';
    }

    updateUI() {
        const list = document.getElementById('players-list');
        list.innerHTML = '';
        if (this.players.length === 0) return;

        this.players.forEach((p, i) => {
            const div = document.createElement('div');
            div.className = `player-score ${i === this.currentPlayerIndex ? 'active' : ''} ${!p.active ? 'eliminated' : ''}`;
            div.innerHTML = `<span>${p.name}</span> <span>${p.score}</span>`;
            list.appendChild(div);
        });
        const cp = this.players[this.currentPlayerIndex];
        if (cp) {
             document.getElementById('mobile-score-display').innerText = `${cp.name}: ${cp.score}åˆ†`;
        }
        document.getElementById('tiles-left-header').innerText = `${this.numberBag.length + this.operatorBag.length} (æ•°:${this.numberBag.length} | ç¬¦:${this.operatorBag.length})`;
        this.renderRack();
    }

    showMessage(msg, isError = false) {
        const el = document.getElementById('message-area');
        el.style.color = isError ? '#ff6b6b' : '#ffd700';
        el.innerText = msg;
        el.style.transform = "scale(1.02)";
        setTimeout(() => el.style.transform = "scale(1)", 200);
    }
}

const game = new Game();
window.game = game;

// è¾…åŠ©ï¼šåºåˆ—åŒ–/ååºåˆ—åŒ–
function serializeTile(t) { return t ? { char: t.char, id: t.id, score: t.score } : null; }
function deserializeTile(d) { return d ? new Tile(d.char, d.id) : null; }

// --- èŠå¤©å®¤åŠŸèƒ½å‡½æ•° ---

// ä¿®å¤ï¼šæ‰‹æœºæµè§ˆå™¨éŸ³é¢‘è§£é”
function initAudio() {
    if (!audioContext) {
        const AudioContext = window.AudioContext || window.webkitAudioContext;
        if (AudioContext) {
            audioContext = new AudioContext();
        }
    }
    if (audioContext && audioContext.state === 'suspended') {
        audioContext.resume();
    }
}

window.toggleChat = function() {
    initAudio(); // å°è¯•åœ¨ç‚¹å‡»æ—¶è§£é”éŸ³é¢‘
    
    const chatWindow = document.getElementById('chat-window');
    const notif = document.getElementById('chat-notification');
    
    isChatOpen = !isChatOpen;
    
    if (isChatOpen) {
        chatWindow.style.display = 'flex';
        notif.style.display = 'none';
        // è‡ªåŠ¨æ»šåŠ¨åˆ°åº•éƒ¨
        const msgArea = document.getElementById('chat-messages');
        msgArea.scrollTop = msgArea.scrollHeight;
    } else {
        chatWindow.style.display = 'none';
    }
}

window.sendChatMessage = async function() {
    const input = document.getElementById('chat-input');
    const text = input.value.trim();
    if (!text || !currentRoomId) return;
    
    try {
        const msg = {
            sender: myNickname || "æœªçŸ¥ç©å®¶",
            text: text,
            timestamp: Date.now()
        };
        
        await updateDoc(doc(db, "games", currentRoomId), {
            chatLog: arrayUnion(msg)
        });
        
        input.value = '';
    } catch (e) {
        console.error("å‘é€å¤±è´¥", e);
    }
}

function renderChat(chatLog) {
    if (!chatLog) return;
    
    const msgArea = document.getElementById('chat-messages');
    msgArea.innerHTML = ''; 
    
    chatLog.sort((a, b) => a.timestamp - b.timestamp);
    
    let newMessages = false;
    
    chatLog.forEach(msg => {
        const div = document.createElement('div');
        const isMine = msg.sender === myNickname;
        div.className = `chat-msg ${isMine ? 'mine' : 'others'}`;
        
        if (msg.sender === 'System') div.className = 'chat-msg system';
        
        div.innerHTML = `
            <span class="chat-name">${msg.sender}</span>
            ${msg.text}
        `;
        msgArea.appendChild(div);
    });
    
    // æ»šåŠ¨ä¸é€šçŸ¥é€»è¾‘
    if (isChatOpen) {
        msgArea.scrollTop = msgArea.scrollHeight;
    }
    
    // å¦‚æœæœ‰æ–°æ¶ˆæ¯ä¸”ä¸æ˜¯æˆ‘å‘çš„
    if (chatLog.length > lastChatCount) {
        const lastMsg = chatLog[chatLog.length - 1];
        if (lastMsg.sender !== myNickname) {
            playNotificationSound(); // æ’­æ”¾æç¤ºéŸ³
            if (!isChatOpen) {
                document.getElementById('chat-notification').style.display = 'block';
            }
        }
    }
    lastChatCount = chatLog.length;
}

// ä½¿ç”¨ Web Audio API ç”Ÿæˆæç¤ºéŸ³ (æ¸…è„†çš„å®å£°)
function playNotificationSound() {
    try {
        if (!audioContext) initAudio();
        if (!audioContext) return;
        
        if (audioContext.state === 'suspended') audioContext.resume();

        const osc = audioContext.createOscillator();
        const gain = audioContext.createGain();

        osc.connect(gain);
        gain.connect(audioContext.destination);

        // è®¾ç½®éŸ³è‰²å’Œé¢‘ç‡ (ç±»ä¼¼ 'Ding')
        osc.type = 'sine';
        osc.frequency.setValueAtTime(500, audioContext.currentTime);
        osc.frequency.exponentialRampToValueAtTime(1000, audioContext.currentTime + 0.1);
        
        // è®¾ç½®éŸ³é‡åŒ…ç»œ
        gain.gain.setValueAtTime(0.1, audioContext.currentTime);
        gain.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.3);

        osc.start();
        osc.stop(audioContext.currentTime + 0.3);
    } catch (e) {
        console.error("Audio play failed", e);
    }
}

// --- è”æœºå¤§å…é€»è¾‘ ---

window.createRoom = async function() {
    initAudio(); // å…³é”®ï¼šåœ¨ç”¨æˆ·ç‚¹å‡»åˆ›å»ºæ—¶è§£é”éŸ³é¢‘
    
    const nick = document.getElementById('nickname-input').value.trim();
    if (!nick) { updateStatus("âŒ è¯·è¾“å…¥æ˜µç§°"); return; }
    myNickname = nick;
    isHost = true;

    try {
        updateStatus("æ­£åœ¨åˆ›å»º...");
        const userCred = await signInAnonymously(auth);
        myPlayerId = userCred.user.uid;
        
        const roomId = Math.floor(100000 + Math.random() * 900000).toString();
        
        // åˆå§‹æ–‡æ¡£ï¼šç­‰å¾…çŠ¶æ€ + èŠå¤©è®°å½•åˆå§‹åŒ–
        const initialDoc = {
            status: 'waiting',
            hostId: myPlayerId,
            players: [{ uid: myPlayerId, name: nick }],
            chatLog: [], // åˆå§‹åŒ–èŠå¤©è®°å½•
            createdAt: Date.now()
        };

        await setDoc(doc(db, "games", roomId), initialDoc);
        enterWaitingRoom(roomId);

    } catch (e) {
        console.error(e);
        updateStatus("âŒ åˆ›å»ºå¤±è´¥: " + e.message);
    }
}

window.joinRoom = async function() {
    initAudio(); // å…³é”®ï¼šåœ¨ç”¨æˆ·ç‚¹å‡»åŠ å…¥æ—¶è§£é”éŸ³é¢‘
    
    const nick = document.getElementById('nickname-input').value.trim();
    if (!nick) { updateStatus("âŒ è¯·è¾“å…¥æ˜µç§°"); return; }
    myNickname = nick;
    
    const inputId = document.getElementById('room-input').value;
    if (inputId.length !== 6) { updateStatus("âŒ è¯·è¾“å…¥6ä½æˆ¿é—´å·"); return; }

    try {
        updateStatus("æ­£åœ¨è¿æ¥...");
        const userCred = await signInAnonymously(auth);
        myPlayerId = userCred.user.uid;

        const roomRef = doc(db, "games", inputId);
        const snap = await getDoc(roomRef);

        if (!snap.exists()) { updateStatus("âŒ æˆ¿é—´ä¸å­˜åœ¨"); return; }
        const data = snap.data();

        if (data.status !== 'waiting') { updateStatus("âŒ æ¸¸æˆå·²å¼€å§‹æˆ–å·²ç»“æŸ"); return; }
        if (data.players.length >= 4) { updateStatus("âŒ æˆ¿é—´å·²æ»¡"); return; }
        
        // æ£€æŸ¥æ˜µç§°é‡å¤ï¼ˆç®€å•å¤„ç†ï¼‰
        if (data.players.some(p => p.name === nick)) {
             updateStatus("âŒ æ˜µç§°å·²è¢«å ç”¨ï¼Œè¯·æ¢ä¸€ä¸ª"); return;
        }

        // åŠ å…¥ç©å®¶åˆ—è¡¨
        await updateDoc(roomRef, {
            players: arrayUnion({ uid: myPlayerId, name: nick })
        });

        enterWaitingRoom(inputId);

    } catch (e) {
        console.error(e);
        updateStatus("âŒ åŠ å…¥å¤±è´¥: " + e.message);
    }
}

function enterWaitingRoom(roomId) {
    currentRoomId = roomId;
    document.getElementById('lobby-initial').style.display = 'none';
    document.getElementById('waiting-area').style.display = 'block';
    document.getElementById('display-room-id').innerText = roomId;
    
    // æ˜¾ç¤ºèŠå¤©å…¥å£
    document.getElementById('chat-container').style.display = 'flex';
    
    // ç›‘å¬æˆ¿é—´æ›´æ–°
    onSnapshot(doc(db, "games", roomId), (docSnap) => {
        if (!docSnap.exists()) return;
        const data = docSnap.data();
        
        // æ›´æ–°ç©å®¶åˆ—è¡¨
        if (data.players) updateWaitingUI(data.players);
        
        // æ›´æ–°èŠå¤©
        if (data.chatLog) renderChat(data.chatLog);

        // å¦‚æœæ¸¸æˆå¼€å§‹äº†ï¼Œè¿›å…¥æ¸¸æˆç•Œé¢
        if (data.status === 'playing') {
             const lobbyVisible = document.getElementById('lobby-overlay').style.display !== 'none';
             document.getElementById('lobby-overlay').style.display = 'none';
             syncGameState(data);
             hookGameLogic(); // æ¿€æ´»æ¸¸æˆæ“ä½œé’©å­
             
             // ä¿®å¤ï¼šä»å¤§å…åˆ‡æ¢åˆ°æ¸¸æˆæ—¶ï¼Œè‡ªåŠ¨å¼¹çª—
             if(lobbyVisible && !hasShownTutorial) {
                 hasShownTutorial = true;
                 game.showTutorial();
             }
        }
    });
}

function updateWaitingUI(players) {
    const listEl = document.getElementById('waiting-list');
    listEl.innerHTML = '';
    document.getElementById('player-count').innerText = players.length;

    players.forEach(p => {
        const div = document.createElement('div');
        div.className = 'player-list-item';
        div.innerHTML = `
            <span>${p.name} ${p.uid === myPlayerId ? '(æˆ‘)' : ''}</span>
            ${p.uid === players[0].uid ? 'ğŸ‘‘ æˆ¿ä¸»' : 'âœ… å·²å‡†å¤‡'}
        `;
        listEl.appendChild(div);
    });

    // æ§åˆ¶å¼€å§‹æŒ‰é’®
    const hostControls = document.getElementById('host-controls');
    const guestMsg = document.getElementById('guest-msg');
    
    if (isHost) {
        hostControls.style.display = 'block';
        const startBtn = hostControls.querySelector('button');
        if (players.length < 2) {
            startBtn.disabled = true;
            startBtn.innerText = "ç­‰å¾…è‡³å°‘2äºº...";
            startBtn.style.opacity = 0.5;
        } else {
            startBtn.disabled = false;
            startBtn.innerText = "å¼€å§‹æ¸¸æˆ";
            startBtn.style.opacity = 1;
        }
    } else {
        guestMsg.style.display = 'block';
    }
}

// æˆ¿ä¸»ç‚¹å‡»å¼€å§‹æ¸¸æˆ
window.startGameAsHost = async function() {
    if (!isHost || !currentRoomId) return;
    
    try {
        // 1. è·å–æœ€æ–°ç©å®¶åˆ—è¡¨
        const snap = await getDoc(doc(db, "games", currentRoomId));
        const currentPlayers = snap.data().players;

        // 2. åˆå§‹åŒ–æ¸¸æˆæ ¸å¿ƒæ•°æ®
        game.setupPlayers(currentPlayers.map(p => p.name));
        game.generateTileBag();
        game.shuffleBag();
        // å‘ç‰Œ
        game.players.forEach(p => game.drawTiles(p));
        game.renderBoard(); // ä¸ºäº†ç”Ÿæˆåˆå§‹boardState

        // 3. åºåˆ—åŒ–æ•°æ®
        const boardData = game.boardState.map(row => row.map(c => serializeTile(c)));
        
        const gameState = {
            status: 'playing',
            board: JSON.stringify(boardData),
            players: game.players.map(p => ({
                name: p.name,
                score: p.score,
                misses: p.misses,
                active: p.active,
                rack: p.rack.map(t => serializeTile(t))
            })),
            numberBag: game.numberBag.map(t => serializeTile(t)),
            operatorBag: game.operatorBag.map(t => serializeTile(t)),
            currentPlayerIndex: 0,
            isFirstTurn: true
        };

        // 4. å†™å…¥ Firestore
        await updateDoc(doc(db, "games", currentRoomId), gameState);

    } catch (e) {
        console.error(e);
        alert("å¼€å§‹æ¸¸æˆå‡ºé”™: " + e.message);
    }
}

function syncGameState(data) {
    if (!data || data.status !== 'playing') return;
    
    // æ¢å¤åŸºç¡€å˜é‡
    game.currentPlayerIndex = data.currentPlayerIndex;
    game.isFirstTurn = data.isFirstTurn;
    
    // æ¢å¤æ£‹ç›˜
    if (typeof data.board === 'string') {
        const parsedBoard = JSON.parse(data.board);
        game.boardState = parsedBoard.map((row, r) => 
            row.map((cell, c) => cell ? deserializeTile(cell) : null)
        );
    }

    // æ¢å¤ç©å®¶ (é‡è¦ï¼šå¦‚æœæ˜¯ç¬¬ä¸€æ¬¡åŒæ­¥ï¼Œè¿™é‡Œä¼šæŠŠæ‰€æœ‰ç©å®¶æ•°æ®åŠ è½½è¿›æ¥)
    // å¦‚æœæœ¬åœ° game.players é•¿åº¦ä¸å¯¹ï¼Œè¯´æ˜æ˜¯åˆšå¼€å§‹
    if (game.players.length !== data.players.length) {
        game.players = data.players.map(d => ({
            name: d.name,
            score: d.score,
            misses: d.misses,
            active: d.active,
            rack: d.rack.map(t => deserializeTile(t))
        }));
    } else {
        // æ›´æ–°ç°æœ‰ç©å®¶æ•°æ®
        game.players.forEach((p, i) => {
            const d = data.players[i];
            p.score = d.score;
            p.misses = d.misses;
            p.active = d.active;
            p.name = d.name;
            // æ¯”è¾ƒå¹¶æ›´æ–°æ‰‹ç‰Œ
            if(JSON.stringify(p.rack.map(t=>t.id)) !== JSON.stringify(d.rack.map(t=>t.id))) {
                p.rack = d.rack.map(t => deserializeTile(t));
            }
        });
    }
    
    // æ¢å¤ç‰Œè¢‹
    if (game.numberBag.length !== data.numberBag.length) game.numberBag = data.numberBag.map(t => deserializeTile(t));
    if (game.operatorBag.length !== data.operatorBag.length) game.operatorBag = data.operatorBag.map(t => deserializeTile(t));

    // æ¸²æŸ“
    game.renderBoard();
    game.renderRack();
    game.updateUI();

    // æç¤ºä¿¡æ¯
    const currentPlayerName = game.players[game.currentPlayerIndex].name;
    if (currentPlayerName === myNickname) {
        game.showMessage("ğŸ‘‰ è½®åˆ°ä½ äº†ï¼è¯·å‡ºç‰Œ");
        document.title = "ğŸ”´ åˆ°ä½ äº†! - G-MATH";
    } else {
        game.showMessage(`ç­‰å¾… ${currentPlayerName} å‡ºç‰Œ...`);
        document.title = "G-MATH (ç­‰å¾…ä¸­)";
    }
}

async function pushGameState() {
    if (!currentRoomId) return;
    
    const boardData = game.boardState.map(row => row.map(c => serializeTile(c)));
    
    const state = {
        board: JSON.stringify(boardData),
        players: game.players.map(p => ({
            name: p.name,
            score: p.score,
            misses: p.misses,
            active: p.active,
            rack: p.rack.map(t => serializeTile(t))
        })),
        numberBag: game.numberBag.map(t => serializeTile(t)),
        operatorBag: game.operatorBag.map(t => serializeTile(t)),
        currentPlayerIndex: game.currentPlayerIndex,
        isFirstTurn: game.isFirstTurn
    };
    
    await updateDoc(doc(db, "games", currentRoomId), state);
}

function hookGameLogic() {
    // æ‹¦æˆª nextTurn
    const originalNextTurn = game.nextTurn.bind(game);
    game.nextTurn = function(isValidMove) {
        originalNextTurn(isValidMove);
        pushGameState();
    }
    
    // æ‹¦æˆªæ£‹ç›˜ç‚¹å‡»
    const originalHandleBoardClick = game.handleBoardClick.bind(game);
    game.handleBoardClick = function(r, c) {
        const cpName = game.players[game.currentPlayerIndex].name;
        if (cpName !== myNickname) {
            game.showMessage("ğŸš« è¿˜æ²¡è½®åˆ°ä½ ï¼", true);
            return;
        }
        originalHandleBoardClick(r, c);
    }
    
    // æ‹¦æˆªæŒ‰é’®
    const protectButtons = ['playTurn', 'passTurn', 'toggleSwapMode'];
    protectButtons.forEach(method => {
        const original = game[method].bind(game);
        game[method] = function(...args) {
            const cpName = game.players[game.currentPlayerIndex].name;
            if (cpName !== myNickname) {
                game.showMessage("ğŸš« è¿˜æ²¡è½®åˆ°ä½ ï¼", true);
                return;
            }
            original(...args);
        }
    });
    // recallTiles å…è®¸éšæ—¶æ“ä½œï¼ˆæœ¬åœ°æ•´ç†ï¼‰
}

function updateStatus(msg) {
    const el = document.getElementById('lobby-status');
    if(el) el.innerText = msg;
}
</script>
</body>
</html>
